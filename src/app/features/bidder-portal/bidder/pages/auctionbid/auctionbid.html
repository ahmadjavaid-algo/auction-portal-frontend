<div class="bidding-theater" *ngIf="!loading; else loadingState">
  <!-- THEME TOGGLE (FLOATING) -->
  <button class="theme-toggle-fab" (click)="toggleTheme()" [attr.aria-label]="isLightMode ? 'Switch to dark mode' : 'Switch to light mode'">
    <mat-icon>{{ isLightMode ? 'dark_mode' : 'light_mode' }}</mat-icon>
  </button>

  <!-- HERO BANNER -->
  <header class="hero-banner" [ngStyle]="{ '--hero-img': 'url(' + bannerImage + ')' }">
    <div class="hero-overlay"></div>
    <div class="hero-noise"></div>

    <div class="hero-shell">
      <!-- Top row -->
      <div class="hero-top">
        <div class="hero-crumbs">
          <a class="crumb" routerLink="/bidder/auctions">
            <span class="dot"></span>
            Auctions
          </a>
          <span class="sep"></span>
          <a class="crumb" [routerLink]="['/bidder/auctions', auctionId]">
            <span class="dot"></span>
            {{ auction?.auctionName || ('Auction #' + auctionId) }}
          </a>
          <span class="sep"></span>
          <span class="crumb current">
            <span class="dot"></span>
            Lot #{{ lotId }}
          </span>
        </div>

        <div class="hero-pills">
          <div class="pill state" [ngClass]="auctionState">
            <span class="p-dot"></span>
            <span class="p-txt">
              {{
                auctionState === 'live'
                  ? 'LIVE'
                  : auctionState === 'scheduled'
                  ? 'SCHEDULED'
                  : auctionState === 'ended'
                  ? 'ENDED'
                  : 'UNKNOWN'
              }}
            </span>
          </div>

          <div class="pill countdown" [ngClass]="auctionState">
            <mat-icon>schedule</mat-icon>
            <span class="p-txt">{{ auctionCountdown }}</span>
          </div>
        </div>
      </div>

      <!-- Main hero content -->
      <div class="hero-main">
        <div class="hero-kicker">
          <span class="k-chip">LOT #{{ lotId }}</span>
          <span class="k-sep">•</span>
          <span class="k-auction">{{ auction?.auctionName || ('Auction #' + auctionId) }}</span>
        </div>

        <h1 class="hero-title">{{ title }}</h1>
        <div class="hero-sub">{{ subtitle }}</div>

        <div class="hero-metrics">
          <div class="metric">
            <div class="m-label">Current</div>
            <div class="m-value price">{{ money(currentPrice ?? lotStartPrice) }}</div>
            <div class="m-sub">Start {{ money(lotStartPrice) }}</div>
          </div>

          <div class="metric">
            <div class="m-label">Your Status</div>
            <div class="m-value status" [ngClass]="yourStatus.toLowerCase().replace(' ', '-')">
              <mat-icon *ngIf="yourStatus === 'Winning' || yourStatus === 'Won'">emoji_events</mat-icon>
              <mat-icon *ngIf="yourStatus === 'Outbid' || yourStatus === 'Lost'">trending_down</mat-icon>
              <mat-icon *ngIf="yourStatus === 'No Bids'">gavel</mat-icon>
              <span>{{ yourStatus }}</span>
            </div>
            <div class="m-sub" *ngIf="yourMaxBid != null">Top {{ money(yourMaxBid) }}</div>
            <div class="m-sub" *ngIf="yourMaxBid == null">No bids placed</div>
          </div>

          <div class="metric" *ngIf="lotBidIncrement">
            <div class="m-label">Increment</div>
            <div class="m-value mono">{{ money(lotBidIncrement) }}</div>
            <div class="m-sub">Minimum step</div>
          </div>

          <div class="metric" *ngIf="lotReservePrice">
            <div class="m-label">Reserve</div>
            <div class="m-value reserve" [class.met]="isReserveMet">
              <mat-icon>{{ isReserveMet ? 'check_circle' : 'info' }}</mat-icon>
              <span>{{ isReserveMet ? 'MET' : 'NOT MET' }}</span>
            </div>
            <div class="m-sub">{{ money(lotReservePrice) }}</div>
          </div>
        </div>
      </div>

      <!-- Buttons row -->
      <div class="hero-bottom">
        <button class="view-gallery-btn" (click)="openProductGallery()" *ngIf="images.length > 0">
          <mat-icon>photo_library</mat-icon>
          <span>View Product Gallery ({{ images.length }} {{ images.length === 1 ? 'Photo' : 'Photos' }})</span>
        </button>

        <button class="compare-btn" (click)="goToCompare()">
          <mat-icon>compare_arrows</mat-icon>
          <span>Compare with Other Vehicles</span>
        </button>

        <!-- ===== NEW: AI REPORT BUTTON ===== -->
        <button class="ai-report-trigger" (click)="generateAIReport()" *ngIf="!aiReportVisible" [disabled]="aiReportGenerating">
          <div class="ai-glow"></div>
          <mat-icon>psychology</mat-icon>
          <span>{{ aiReportGenerating ? 'Generating AI Report...' : 'Generate AlgoX AI Report' }}</span>
          <div class="ai-badge">POWERED BY AI</div>
        </button>
      </div>
    </div>
  </header>

  <!-- ===== NEW: AI REPORT & PREDICTION SECTION ===== -->
  <div class="ai-report-container" *ngIf="aiReportVisible" [@slideInOut]>
    <!-- Generation Progress Overlay -->
    <div class="ai-generating-overlay" *ngIf="aiReportGenerating">
      <div class="generation-content">
        <div class="ai-logo-spinner">
          <mat-icon>psychology</mat-icon>
          <div class="spinner-ring"></div>
          <div class="spinner-ring ring-2"></div>
          <div class="spinner-ring ring-3"></div>
        </div>
        <h3>AlgoX AI is Analyzing...</h3>
        <div class="generation-bar">
          <div class="generation-fill" [style.width.%]="aiReportGenerationProgress"></div>
        </div>
        <p class="generation-stage">Processing {{ aiReportGenerationProgress }}%</p>
      </div>
    </div>

    <!-- Generated Report -->
    <div class="ai-report-main" *ngIf="!aiReportGenerating && aiReportData">
      <!-- Report Header -->
      <div class="ai-report-header">
        <div class="header-left">
          <div class="ai-badge-large">
            <mat-icon>psychology</mat-icon>
            <span>AlgoX AI</span>
          </div>
          <div class="header-text">
            <h2>AI-Powered Vehicle Analysis & Prediction</h2>
            <p>Comprehensive analysis using advanced algorithms, market data, and predictive modeling</p>
          </div>
        </div>
        <button class="btn-close-report" (click)="closeAIReport()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <!-- Overall Score & Recommendation -->
      <div class="ai-overview-grid">
        <!-- Overall Score Circle -->
        <div class="overview-card score-card">
          <div class="score-visual">
            <svg class="score-circle" viewBox="0 0 200 200">
              <circle class="score-bg" cx="100" cy="100" r="90" />
              <circle 
                class="score-progress" 
                cx="100" 
                cy="100" 
                r="90"
                [style.stroke-dashoffset]="565 - (565 * aiReportData.overallScore / 100)"
              />
            </svg>
            <div class="score-number">{{ aiReportData.overallScore }}</div>
          </div>
          <div class="score-label">Overall Score</div>
          <div class="score-sublabel">Out of 100</div>
        </div>

        <!-- Recommendation -->
        <div class="overview-card recommendation-card">
          <div class="recommendation-icon" [style.color]="getRecommendationColor()">
            <mat-icon>{{ getRecommendationIcon() }}</mat-icon>
          </div>
          <div class="recommendation-badge" [style.background]="getRecommendationColor() + '22'" [style.border-color]="getRecommendationColor()">
            {{ getRecommendationText() }}
          </div>
          <div class="recommendation-subtitle">AI Recommendation</div>
          <div class="confidence-meter">
            <div class="conf-label">Confidence: {{ aiReportData.confidence }}%</div>
            <div class="conf-bar">
              <div class="conf-fill" [style.width.%]="aiReportData.confidence"></div>
            </div>
          </div>
        </div>

        <!-- Value Rating -->
        <div class="overview-card value-card">
          <div class="value-stars">
            <mat-icon *ngFor="let star of [1,2,3,4,5]" [class.filled]="star <= aiReportData.valueRating">
              {{ star <= aiReportData.valueRating ? 'star' : 'star_border' }}
            </mat-icon>
          </div>
          <div class="value-label">Value Rating</div>
          <div class="value-sublabel">{{ aiReportData.valueRating }} out of 5 stars</div>
        </div>

        <!-- Predicted Final Price -->
        <div class="overview-card prediction-card">
          <div class="prediction-value">{{ money(aiReportData.predictedFinalPrice) }}</div>
          <div class="prediction-label">Predicted Final Price</div>
          <div class="prediction-position">
            <mat-icon>{{ aiReportData.currentMarketPosition === 'below' ? 'trending_down' : aiReportData.currentMarketPosition === 'above' ? 'trending_up' : 'trending_flat' }}</mat-icon>
            <span>Currently {{ aiReportData.currentMarketPosition }} market value</span>
          </div>
        </div>
      </div>

      <!-- Analysis Sections -->
      <div class="ai-sections-grid">
        <!-- Condition -->
        <div class="analysis-section" [class.expanded]="aiReportExpanded">
          <div class="section-header">
            <div class="section-icon">
              <mat-icon>{{ aiReportData.sections.condition.icon }}</mat-icon>
            </div>
            <div class="section-title-group">
              <h3>{{ aiReportData.sections.condition.title }}</h3>
              <div class="section-score" [class]="aiReportData.sections.condition.status">
                {{ aiReportData.sections.condition.score }}/100
                <mat-icon class="trend-icon" *ngIf="aiReportData.sections.condition.trend">
                  {{ aiReportData.sections.condition.trend === 'up' ? 'trending_up' : aiReportData.sections.condition.trend === 'down' ? 'trending_down' : 'trending_flat' }}
                </mat-icon>
              </div>
            </div>
          </div>
          <p class="section-summary">{{ aiReportData.sections.condition.summary }}</p>
          <ul class="section-details" *ngIf="aiReportExpanded">
            <li *ngFor="let detail of aiReportData.sections.condition.details">{{ detail }}</li>
          </ul>
        </div>

        <!-- Pricing -->
        <div class="analysis-section" [class.expanded]="aiReportExpanded">
          <div class="section-header">
            <div class="section-icon">
              <mat-icon>{{ aiReportData.sections.pricing.icon }}</mat-icon>
            </div>
            <div class="section-title-group">
              <h3>{{ aiReportData.sections.pricing.title }}</h3>
              <div class="section-score" [class]="aiReportData.sections.pricing.status">
                {{ aiReportData.sections.pricing.score }}/100
                <mat-icon class="trend-icon" *ngIf="aiReportData.sections.pricing.trend">
                  {{ aiReportData.sections.pricing.trend === 'up' ? 'trending_up' : aiReportData.sections.pricing.trend === 'down' ? 'trending_down' : 'trending_flat' }}
                </mat-icon>
              </div>
            </div>
          </div>
          <p class="section-summary">{{ aiReportData.sections.pricing.summary }}</p>
          <ul class="section-details" *ngIf="aiReportExpanded">
            <li *ngFor="let detail of aiReportData.sections.pricing.details">{{ detail }}</li>
          </ul>
        </div>

        <!-- Competition -->
        <div class="analysis-section" [class.expanded]="aiReportExpanded">
          <div class="section-header">
            <div class="section-icon">
              <mat-icon>{{ aiReportData.sections.competition.icon }}</mat-icon>
            </div>
            <div class="section-title-group">
              <h3>{{ aiReportData.sections.competition.title }}</h3>
              <div class="section-score" [class]="aiReportData.sections.competition.status">
                {{ aiReportData.sections.competition.score }}/100
                <mat-icon class="trend-icon" *ngIf="aiReportData.sections.competition.trend">
                  {{ aiReportData.sections.competition.trend === 'up' ? 'trending_up' : aiReportData.sections.competition.trend === 'down' ? 'trending_down' : 'trending_flat' }}
                </mat-icon>
              </div>
            </div>
          </div>
          <p class="section-summary">{{ aiReportData.sections.competition.summary }}</p>
          <ul class="section-details" *ngIf="aiReportExpanded">
            <li *ngFor="let detail of aiReportData.sections.competition.details">{{ detail }}</li>
          </ul>
        </div>

        <!-- Market Trend -->
        <div class="analysis-section" [class.expanded]="aiReportExpanded">
          <div class="section-header">
            <div class="section-icon">
              <mat-icon>{{ aiReportData.sections.marketTrend.icon }}</mat-icon>
            </div>
            <div class="section-title-group">
              <h3>{{ aiReportData.sections.marketTrend.title }}</h3>
              <div class="section-score" [class]="aiReportData.sections.marketTrend.status">
                {{ aiReportData.sections.marketTrend.score }}/100
                <mat-icon class="trend-icon" *ngIf="aiReportData.sections.marketTrend.trend">
                  {{ aiReportData.sections.marketTrend.trend === 'up' ? 'trending_up' : aiReportData.sections.marketTrend.trend === 'down' ? 'trending_down' : 'trending_flat' }}
                </mat-icon>
              </div>
            </div>
          </div>
          <p class="section-summary">{{ aiReportData.sections.marketTrend.summary }}</p>
          <ul class="section-details" *ngIf="aiReportExpanded">
            <li *ngFor="let detail of aiReportData.sections.marketTrend.details">{{ detail }}</li>
          </ul>
        </div>

        <!-- Timing -->
        <div class="analysis-section" [class.expanded]="aiReportExpanded">
          <div class="section-header">
            <div class="section-icon">
              <mat-icon>{{ aiReportData.sections.timing.icon }}</mat-icon>
            </div>
            <div class="section-title-group">
              <h3>{{ aiReportData.sections.timing.title }}</h3>
              <div class="section-score" [class]="aiReportData.sections.timing.status">
                {{ aiReportData.sections.timing.score }}/100
                <mat-icon class="trend-icon" *ngIf="aiReportData.sections.timing.trend">
                  {{ aiReportData.sections.timing.trend === 'up' ? 'trending_up' : aiReportData.sections.timing.trend === 'down' ? 'trending_down' : 'trending_flat' }}
                </mat-icon>
              </div>
            </div>
          </div>
          <p class="section-summary">{{ aiReportData.sections.timing.summary }}</p>
          <ul class="section-details" *ngIf="aiReportExpanded">
            <li *ngFor="let detail of aiReportData.sections.timing.details">{{ detail }}</li>
          </ul>
        </div>
      </div>

      <!-- Expand/Collapse Button -->
      <button class="btn-expand-sections" (click)="toggleAIReportExpand()">
        <mat-icon>{{ aiReportExpanded ? 'expand_less' : 'expand_more' }}</mat-icon>
        <span>{{ aiReportExpanded ? 'Show Less Details' : 'Show Full Analysis' }}</span>
      </button>

      <!-- Key Insights -->
      <div class="ai-insights-section">
        <h3 class="insights-title">
          <mat-icon>lightbulb</mat-icon>
          Key Insights
        </h3>
        <div class="insights-grid">
          <div class="insight-card" *ngFor="let insight of aiReportData.keyInsights">
            <mat-icon>check_circle</mat-icon>
            <p>{{ insight }}</p>
          </div>
        </div>
      </div>

      <!-- Risk Factors -->
      <div class="ai-risks-section">
        <h3 class="risks-title">
          <mat-icon>shield</mat-icon>
          Risk Factors
        </h3>
        <div class="risks-list">
          <div class="risk-item" *ngFor="let risk of aiReportData.riskFactors">
            <mat-icon>warning</mat-icon>
            <p>{{ risk }}</p>
          </div>
        </div>
      </div>

      <!-- Next Bid Recommendation -->
      <div class="ai-bid-recommendation">
        <div class="recommendation-header">
          <mat-icon>auto_awesome</mat-icon>
          <h3>AI Bid Strategy</h3>
        </div>
        <div class="recommendation-content">
          <div class="recommended-bid">
            <div class="bid-label">Recommended Next Bid</div>
            <div class="bid-amount">{{ money(aiReportData.nextBidRecommendation.amount) }}</div>
            <div class="bid-confidence">{{ aiReportData.nextBidRecommendation.confidence }}% Confidence</div>
          </div>
          <div class="recommendation-timing">
            <mat-icon>schedule</mat-icon>
            <p>{{ aiReportData.nextBidRecommendation.timing }}</p>
          </div>
        </div>
      </div>

      <!-- Report Footer -->
      <div class="ai-report-footer">
        <div class="footer-disclaimer">
          <mat-icon>info</mat-icon>
          <p>This AI-generated report is for informational purposes only. AlgoX AI analyzes multiple data points including inspection reports, bid patterns, market trends, and historical data. Always conduct your own due diligence before making bidding decisions.</p>
        </div>
        <button class="btn-regenerate" (click)="generateAIReport()">
          <mat-icon>refresh</mat-icon>
          <span>Regenerate Analysis</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content Grid (EXISTING) -->
  <div class="content-grid">
    <!-- Left Column: Details (EXISTING CONTENT) -->
    <div class="left-column">
      <!-- Status & Price Cards -->
      <div class="cards-row">
        <div class="glass-card status-card">
          <div class="card-label">Your Status</div>
          <div class="status-badge" [ngClass]="yourStatus.toLowerCase().replace(' ', '-')">
            <mat-icon *ngIf="yourStatus === 'Winning' || yourStatus === 'Won'">emoji_events</mat-icon>
            <mat-icon *ngIf="yourStatus === 'Outbid' || yourStatus === 'Lost'">trending_down</mat-icon>
            <mat-icon *ngIf="yourStatus === 'No Bids'">gavel</mat-icon>
            <span>{{ yourStatus }}</span>
          </div>
          <div class="status-details">
            <span *ngIf="yourMaxBid != null">Your top bid: <strong>{{ money(yourMaxBid) }}</strong></span>
            <span *ngIf="yourMaxBid == null">Place your first bid below</span>
          </div>
        </div>

        <div class="glass-card price-card">
          <div class="card-label">Current Price</div>
          <div class="price-value">{{ money(currentPrice ?? lotStartPrice) }}</div>
          <div class="price-meta">
            <span class="meta-item">Start: {{ money(lotStartPrice) }}</span>
            <span class="meta-item" *ngIf="lotBidIncrement">Inc: {{ money(lotBidIncrement) }}</span>
          </div>
        </div>

        <div class="glass-card reserve-card" [class.met]="isReserveMet" *ngIf="lotReservePrice">
          <div class="card-label">Reserve</div>
          <div class="reserve-badge">
            <mat-icon>{{ isReserveMet ? 'check_circle' : 'info' }}</mat-icon>
            <span>{{ isReserveMet ? 'MET' : 'NOT MET' }}</span>
          </div>
          <div class="reserve-value">{{ money(lotReservePrice) }}</div>
        </div>
      </div>

      <!-- AI Auto-Bid Showcase -->
      <div class="ai-showcase" *ngIf="hasAutoBidHistory">
        <div class="ai-header">
          <div class="ai-icon">
            <mat-icon>auto_awesome</mat-icon>
          </div>
          <div class="ai-text">
            <div class="ai-title">AI Auto-Bidding Active</div>
            <div class="ai-subtitle">AlgoX AI is monitoring this auction for you</div>
          </div>
        </div>
        <div class="ai-stats">
          <div class="ai-stat">
            <div class="stat-label">Your AI Max</div>
            <div class="stat-value">{{ money(autoBidCeiling) }}</div>
          </div>
          <div class="ai-stat">
            <div class="stat-label">Status</div>
            <div class="stat-value active">{{ auctionState === 'live' ? 'LIVE' : 'QUEUED' }}</div>
          </div>
        </div>
        <div class="ai-description">
          Our AI will automatically place strategic bids on your behalf, keeping you in the lead up to your maximum budget. Sit back and let technology work for you.
        </div>
      </div>

      <!-- Bid History Timeline -->
      <div class="glass-card history-card">
        <div class="card-header">
          <div class="header-left">
            <mat-icon>history</mat-icon>
            <h2>Bid History</h2>
          </div>
          <div class="bid-count">{{ bids.length }} {{ bids.length === 1 ? 'Bid' : 'Bids' }}</div>
        </div>

        <div class="empty-history" *ngIf="bids.length === 0">
          <mat-icon>gavel</mat-icon>
          <span>No bids placed yet. Be the first!</span>
        </div>

        <div class="bid-timeline" *ngIf="bids.length > 0">
          <div
            class="timeline-item"
            *ngFor="let bid of bids; let i = index; let isFirst = first"
            [class.is-top]="isFirst"
            [class.is-mine]="bid.isMine"
            [class.is-ai]="bid.isAutoBid"
          >
            <div class="timeline-dot"></div>
            <div class="timeline-line" *ngIf="i < bids.length - 1"></div>

            <div class="bid-card">
              <div class="bid-header">
                <div class="bid-user">
                  <mat-icon>{{ bid.isMine ? 'person' : 'person_outline' }}</mat-icon>
                  <span class="bidder-name">
                    {{ bid.isMine ? 'You' : (bid.createdByDisplayName || ('Bidder #' + (bid.createdById || '—'))) }}
                  </span>
                  <span class="ai-badge" *ngIf="bid.isAutoBid">
                    <mat-icon>auto_awesome</mat-icon>
                    AI BID
                  </span>
                </div>
                <div class="bid-amount">{{ money(bid.amount) }}</div>
              </div>

              <div class="bid-footer">
                <span class="bid-time">{{ formatDate(bid.createdDate) }}</span>
                <span class="bid-status" *ngIf="isFirst">LEADING BID</span>
                <span class="bid-status" *ngIf="bid.statusName && !isFirst">{{ bid.statusName }}</span>
              </div>

              <div class="ai-indicator" *ngIf="bid.isAutoBid">
                <mat-icon>psychology</mat-icon>
                <span>AI placed this bid strategically</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Vehicle Specifications -->
      <div class="glass-card specs-card">
        <div class="card-header">
          <mat-icon>directions_car</mat-icon>
          <h2>Vehicle Specifications</h2>
        </div>
        <div class="specs-grid">
          <div class="spec-row" *ngFor="let spec of specs">
            <div class="spec-label">{{ spec.label }}</div>
            <div class="spec-value">{{ spec.value || '—' }}</div>
          </div>
        </div>
      </div>

      <!-- Inspection Report (EXISTING) -->
      <div class="glass-card inspection-card" *ngIf="inventory">
        <div class="card-header">
          <mat-icon>fact_check</mat-icon>
          <h2>Inspection Report</h2>
        </div>

        <div class="inspection-loader" *ngIf="reportLoading">
          <mat-progress-bar mode="indeterminate"></mat-progress-bar>
          <span>Loading inspection data...</span>
        </div>

        <div class="inspection-empty" *ngIf="!reportLoading && reportGroups.length === 0">
          <mat-icon>content_paste_off</mat-icon>
          <div class="empty-text">
            <strong>No inspection report available</strong>
            <span>This vehicle hasn't been inspected yet</span>
          </div>
        </div>

        <div class="inspection-content" *ngIf="!reportLoading && reportGroups.length > 0">
          <div class="inspection-summary">
            <div class="summary-stat">
              <div class="stat-value">{{ totalCheckpoints }}</div>
              <div class="stat-label">Total Checks</div>
            </div>
            <div class="summary-stat">
              <div class="stat-value">{{ totalCompleted }}</div>
              <div class="stat-label">Completed</div>
            </div>
            <div class="summary-stat">
              <div class="stat-value">{{ overallProgressPercent }}%</div>
              <div class="stat-label">Progress</div>
            </div>
            <div class="summary-stat">
              <div class="stat-badge" [style.border-color]="getCompletionStatusColor()" [style.color]="getCompletionStatusColor()">
                {{ getCompletionStatus() }}
              </div>
            </div>
          </div>

          <mat-divider></mat-divider>

          <mat-tab-group class="inspection-tabs">
            <mat-tab *ngFor="let group of reportGroups">
              <ng-template mat-tab-label>
                <div class="tab-label">
                  <span class="tab-name">{{ group.inspectionTypeName }}</span>
                  <span class="tab-progress">{{ getGroupCompleted(group) }}/{{ getGroupTotal(group) }}</span>
                </div>
              </ng-template>

              <div class="tab-content">
                <div class="checkpoint-list">
                  <div class="checkpoint-item" *ngFor="let cp of group.checkpoints" [class.answered]="isRowAnswered(cp)">
                    <div class="checkpoint-main">
                      <mat-icon class="checkpoint-icon">
                        {{ isRowAnswered(cp) ? 'check_circle' : 'radio_button_unchecked' }}
                      </mat-icon>
                      <div class="checkpoint-text">
                        <div class="checkpoint-name">{{ cp.inspectionCheckpointName }}</div>
                        <div class="checkpoint-type">{{ normalizeInputType(cp.inputType) | uppercase }}</div>
                      </div>
                    </div>

                    <div class="checkpoint-result">
                      <div
                        *ngIf="normalizeInputType(cp.inputType) === 'yesno'"
                        class="result-badge"
                        [class.pass]="cp.resultValue === 'Pass'"
                        [class.fail]="cp.resultValue === 'Fail'"
                      >
                        <mat-icon>{{ cp.resultValue === 'Pass' ? 'check_circle' : 'cancel' }}</mat-icon>
                        <span>{{ cp.resultValue || 'Not recorded' }}</span>
                      </div>

                      <div *ngIf="normalizeInputType(cp.inputType) === 'number'" class="result-value">
                        {{ cp.resultValue || '—' }}
                      </div>

                      <div *ngIf="normalizeInputType(cp.inputType) === 'image'" class="result-images">
                        <button
                          class="image-thumb"
                          *ngFor="let img of cp.imageUrls; let idx = index"
                          [ngStyle]="{ '--img': 'url(' + img + ')' }"
                          (click)="openImageViewer(cp.imageUrls!, idx)"
                        ></button>
                        <span class="no-images" *ngIf="!cp.imageUrls?.length">No photos</span>
                      </div>

                      <div
                        *ngIf="normalizeInputType(cp.inputType) === 'text' || normalizeInputType(cp.inputType) === 'textarea'"
                        class="result-text"
                      >
                        {{ cp.resultValue || 'No remarks' }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </mat-tab>
          </mat-tab-group>
        </div>
      </div>
    </div>

    <!-- Right Column: Bidding Panel (EXISTING) -->
    <aside class="right-column">
      <div class="bidding-panel">
        <div class="panel-header">
          <div class="header-icon">
            <mat-icon>gavel</mat-icon>
          </div>
          <div class="header-text">
            <h3>Place Your Bid</h3>
            <div class="auction-status" [ngClass]="auctionState">
              <span class="status-dot"></span>
              <span>{{
                auctionState === 'live'
                  ? 'LIVE BIDDING'
                  : auctionState === 'scheduled'
                  ? 'SCHEDULED'
                  : 'ENDED'
              }}</span>
            </div>
          </div>
        </div>

        <div class="bid-input-group">
          <label>Your Bid Amount</label>
          <div class="input-wrapper">
            <span class="currency">$</span>
            <input type="number" [(ngModel)]="newBidAmount" [disabled]="!isLive || placingBid" placeholder="Enter amount" />
          </div>
          <div class="input-hint">Minimum increment: {{ money(lotBidIncrement) }}</div>
        </div>

        <div class="quick-increments">
          <button class="increment-btn" (click)="adjustBid((lotBidIncrement || 100) * 1)" [disabled]="!isLive || placingBid">
            +{{ money((lotBidIncrement || 100) * 1) }}
          </button>
          <button class="increment-btn" (click)="adjustBid((lotBidIncrement || 100) * 2)" [disabled]="!isLive || placingBid">
            +{{ money((lotBidIncrement || 100) * 2) }}
          </button>
          <button class="increment-btn" (click)="adjustBid((lotBidIncrement || 100) * 5)" [disabled]="!isLive || placingBid">
            +{{ money((lotBidIncrement || 100) * 5) }}
          </button>
        </div>

        <mat-divider></mat-divider>

        <div class="ai-toggle-section">
          <button class="ai-toggle" [class.enabled]="autoBidEnabled" (click)="toggleAutoBid()" [disabled]="!isLive || placingBid">
            <div class="toggle-switch">
              <span class="switch-knob"></span>
            </div>
            <div class="toggle-text">
              <div class="toggle-title">
                <mat-icon>auto_awesome</mat-icon>
                Enable AI Auto-Bidding
              </div>
              <div class="toggle-subtitle">Let our AI bid strategically for you</div>
            </div>
          </button>

          <div class="ai-max-input" *ngIf="autoBidEnabled">
            <label>AI Maximum Budget</label>
            <div class="input-wrapper">
              <span class="currency">$</span>
              <input type="number" [(ngModel)]="autoBidMaxAmount" [disabled]="!isLive || placingBid" placeholder="Maximum amount" />
            </div>
            <div class="input-hint ai">
              <mat-icon>info</mat-icon>
              AI will never exceed this amount
            </div>
          </div>
        </div>

        <button class="btn-place-bid" (click)="placeBid()" [disabled]="!isLive || placingBid">
          <span class="btn-content">
            <mat-icon>{{ placingBid ? 'hourglass_empty' : 'gavel' }}</mat-icon>
            <span *ngIf="!placingBid">{{ autoBidEnabled ? 'ACTIVATE AI BIDDING' : 'PLACE BID' }}</span>
            <span *ngIf="placingBid">PLACING BID...</span>
          </span>
        </button>

        <div class="bid-disclaimer">
          <mat-icon>info</mat-icon>
          <span>All bids are binding. Review details carefully before bidding.</span>
        </div>

        <div class="auction-meta">
          <div class="meta-row">
            <span class="meta-label">Auction</span>
            <span class="meta-value">{{ auction?.auctionName || 'Auction #' + auctionId }}</span>
          </div>
          <div class="meta-row">
            <span class="meta-label">Duration</span>
            <span class="meta-value">{{ formatRange(auction?.startDateTime, auction?.endDateTime) }}</span>
          </div>
          <div class="meta-row" *ngIf="lotBuyNowPrice">
            <span class="meta-label">Buy Now</span>
            <span class="meta-value highlight">{{ money(lotBuyNowPrice) }}</span>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Related lots strip (EXISTING) -->
  <section class="related-lots" *ngIf="relatedLots.length > 0">
    <div class="related-head">
      <div class="h-left">
        <mat-icon>view_carousel</mat-icon>
        <div class="h-text">
          <h2>Related Lots</h2>
          <p>More opportunities in the same auction—tap a card to jump, or quick-bid instantly.</p>
        </div>
      </div>

      <div class="h-right">
        <div class="pill" [ngClass]="auctionState">
          <span class="dot"></span>
          <span>{{ auctionState === 'live' ? 'LIVE' : auctionState === 'scheduled' ? 'SCHEDULED' : 'ENDED' }}</span>
        </div>
      </div>
    </div>

    <div class="related-track" role="list">
      <article
        class="rel-card"
        role="listitem"
        *ngFor="let c of relatedLots"
        tabindex="0"
        (click)="openRelated(c)"
        (keydown.enter)="openRelated(c)"
      >
        <div class="rel-media" [ngStyle]="{ '--img': 'url(' + c.imageUrl + ')' }">
          <div class="rel-overlay"></div>

          <div class="rel-top">
            <div class="count" [ngClass]="c.countdownState">
              <mat-icon>schedule</mat-icon>
              <span>{{ c.countdownState === 'live' ? c.countdownText : (c.countdownText || '—') }}</span>
            </div>

            <div class="reserve" *ngIf="c.reserve != null" [class.met]="c.reserveMet">
              <mat-icon>{{ c.reserveMet ? 'check_circle' : 'info' }}</mat-icon>
              <span>{{ c.reserveMet ? 'RESERVE MET' : 'RESERVE' }}</span>
            </div>
          </div>

          <div class="rel-bottom">
            <div class="rel-title">{{ c.title }}</div>
            <div class="rel-sub">{{ c.sub }}</div>
          </div>
        </div>

        <div class="rel-meta">
          <div class="price">
            <div class="lbl">Current</div>
            <div class="val">{{ money(c.currentPrice ?? c.auctionStartPrice) }}</div>
          </div>

          <button
            class="quickbid"
            (click)="onQuickBidRelated(c, $event)"
            [disabled]="!isLive || c.placingBid || c.bidCooldownActive"
          >
            <mat-icon>{{ c.placingBid ? 'hourglass_empty' : 'flash_on' }}</mat-icon>
            <span *ngIf="!c.bidCooldownActive && !c.placingBid">Quick Bid</span>
            <span *ngIf="c.bidCooldownActive && !c.placingBid">Wait {{ c.bidCooldownRemaining }}s</span>
            <span *ngIf="c.placingBid">Placing…</span>
          </button>
        </div>

        <div class="rel-foot">
          <div class="inc" *ngIf="c.bidIncrement != null">
            <mat-icon>north</mat-icon>
            <span>Inc {{ money(c.bidIncrement) }}</span>
          </div>

          <div class="tap">
            <mat-icon>open_in_new</mat-icon>
            <span>Open lot</span>
          </div>
        </div>
      </article>
    </div>
  </section>
</div>

<!-- Loading State -->
<ng-template #loadingState>
  <div class="loading-screen">
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
    <span>Loading auction details...</span>
  </div>
</ng-template>

<!-- Error State -->
<div class="error-screen" *ngIf="error && !loading">
  <mat-icon>error_outline</mat-icon>
  <h2>{{ error }}</h2>
  <button class="btn-back" routerLink="/bidder/auctions">
    <mat-icon>arrow_back</mat-icon>
    <span>Back to Auctions</span>
  </button>
</div>

<!-- Image Viewer Modal (EXISTING) -->
<div class="image-viewer-modal" *ngIf="showImageViewer" (click)="closeImageViewer()">
  <div class="viewer-backdrop"></div>
  
  <div class="viewer-container" (click)="$event.stopPropagation()">
    <div class="viewer-header">
      <div class="viewer-title">
        <mat-icon>photo_library</mat-icon>
        <span>Product Gallery</span>
        <span class="viewer-counter">{{ selectedImageIndex + 1 }} / {{ selectedImageGallery.length }}</span>
      </div>
      <button class="viewer-close" (click)="closeImageViewer()" aria-label="Close viewer">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="viewer-main">
      <button 
        class="viewer-nav prev" 
        (click)="prevImage()" 
        [disabled]="selectedImageIndex === 0"
        aria-label="Previous image"
      >
        <mat-icon>chevron_left</mat-icon>
      </button>

      <div class="viewer-image-wrapper">
        <img 
          [src]="selectedImageGallery[selectedImageIndex]" 
          alt="Product photo {{ selectedImageIndex + 1 }}" 
          class="viewer-image"
        />
      </div>

      <button 
        class="viewer-nav next" 
        (click)="nextImage()" 
        [disabled]="selectedImageIndex === selectedImageGallery.length - 1"
        aria-label="Next image"
      >
        <mat-icon>chevron_right</mat-icon>
      </button>
    </div>

    <div class="viewer-thumbnails" *ngIf="selectedImageGallery.length > 1">
      <div class="thumbnails-track">
        <button
          *ngFor="let img of selectedImageGallery; let idx = index"
          class="thumbnail"
          [class.active]="idx === selectedImageIndex"
          [ngStyle]="{ '--thumb-img': 'url(' + img + ')' }"
          (click)="selectedImageIndex = idx"
          [attr.aria-label]="'View image ' + (idx + 1)"
        >
          <div class="thumbnail-overlay" *ngIf="idx === selectedImageIndex"></div>
        </button>
      </div>
    </div>

    <div class="viewer-footer">
      <div class="viewer-info">
        <mat-icon>info</mat-icon>
        <span>Use arrow keys or click thumbnails to navigate</span>
      </div>
      <div class="viewer-actions">
        <button class="viewer-action-btn" (click)="prevImage()" [disabled]="selectedImageIndex === 0">
          <mat-icon>arrow_back</mat-icon>
          <span>Previous</span>
        </button>
        <button class="viewer-action-btn" (click)="nextImage()" [disabled]="selectedImageIndex === selectedImageGallery.length - 1">
          <span>Next</span>
          <mat-icon>arrow_forward</mat-icon>
        </button>
      </div>
    </div>
  </div>
</div>