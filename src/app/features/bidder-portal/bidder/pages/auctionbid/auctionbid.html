<!-- src/app/pages/bidder/auctions/auctionbid/auctionbid.html -->
<div class="auction-bid-page" *ngIf="!loading; else busy">
  <!-- breadcrumbs -->
  <div class="crumbs">
    <a routerLink="/bidder/auctions">Auctions</a>
    <mat-icon>chevron_right</mat-icon>
    <a *ngIf="auctionId" [routerLink]="['/bidder/auctions', auctionId]">
      {{ auction?.auctionName || ('Auction #' + auctionId) }}
    </a>
    <mat-icon>chevron_right</mat-icon>
    <span class="current">{{ title }}</span>
  </div>

  <div class="err" *ngIf="error">
    <mat-icon>error_outline</mat-icon>
    <span>{{ error }}</span>
  </div>

  <section class="page" *ngIf="!error">
    <!-- LEFT: vehicle -->
    <div class="main">
      <section class="media">
        <div
          class="stage"
          [ngStyle]="{
            '--photo':
              'url(' + (activeImage || images[0] || heroUrl) + ')'
          }"
        ></div>

        <div class="thumbs" *ngIf="images.length > 1">
          <button
            class="thumb"
            *ngFor="let img of images"
            [class.active]="img === activeImage"
            [ngStyle]="{ '--photo': 'url(' + img + ')' }"
            (click)="selectImage(img)"
            matTooltip="View"
          ></button>
        </div>
      </section>

      <section class="title-block">
        <div class="topline">
          <span class="lot-pill">
            Lot #{{ lotId }}
          </span>
          <span
            class="status-pill"
            [class.live]="isLive"
            [class.ended]="auctionState === 'ended'"
          >
            <mat-icon>schedule</mat-icon>
            <span>{{ auctionCountdown }}</span>
          </span>
        </div>

        <h1>{{ title }}</h1>
        <div class="sub">{{ subtitle }}</div>

        <div class="meta">
          <div class="chip">
            <div class="label">Start Price</div>
            <div class="value">{{ money(lotStartPrice) }}</div>
          </div>

          <!-- ðŸ”´ Reserve chip (default red) that flips ðŸŸ¢ when met -->
          <div class="chip reserve" [class.met]="isReserveMet">
            <div class="label">
              Reserve
              <span class="reserve-badge" *ngIf="lotReservePrice">
                {{ isReserveMet ? 'Met' : 'Not met' }}
              </span>
            </div>
            <div class="value">{{ money(lotReservePrice) }}</div>
          </div>

          <div class="chip">
            <div class="label">Buy Now</div>
            <div class="value">{{ money(lotBuyNowPrice) }}</div>
          </div>
          <div class="chip">
            <div class="label">Bid Increment</div>
            <div class="value">{{ money(lotBidIncrement) }}</div>
          </div>
          <div class="chip">
            <div class="label">Auction Window</div>
            <div class="value">
              {{
                formatRange(
                  auction?.startDateTime || null,
                  auction?.endDateTime || null
                )
              }}
            </div>
          </div>
        </div>

        <div class="your-status">
          <div class="label">Your status</div>
          <div
            class="pill"
            [ngClass]="yourStatus.toLowerCase().replace(' ', '-')"
          >
            <mat-icon *ngIf="yourStatus === 'Winning' || yourStatus === 'Won'">
              emoji_events
            </mat-icon>
            <mat-icon *ngIf="yourStatus === 'Outbid' || yourStatus === 'Lost'">
              warning
            </mat-icon>
            <mat-icon *ngIf="yourStatus === 'No Bids'">person</mat-icon>
            <span>{{ yourStatus }}</span>
          </div>
          <div class="details">
            <span *ngIf="currentPrice != null">
              Current price: <strong>{{ money(currentPrice) }}</strong>
            </span>
            <span *ngIf="yourMaxBid != null">
              â€¢ Your top bid: <strong>{{ money(yourMaxBid) }}</strong>
            </span>
            <span *ngIf="yourMaxBid == null">
              â€¢ You haven't placed a bid yet.
            </span>
          </div>
        </div>
      </section>

      <!-- ðŸ‘‡ Bid history moved directly under Your status -->
      <section class="panel history">
        <div class="head">
          <div class="titles">
            <h3>Bid history</h3>
            <p class="sub">
              Newest bids at the top. 
              <span class="ai-highlight">AI bids glow in neon âœ¨</span>
            </p>
          </div>
          <span class="badge" *ngIf="bids.length">{{ bids.length }} bids</span>
        </div>

        <div class="empty" *ngIf="bids.length === 0">
          <mat-icon>info</mat-icon>
          No bids yet. Be the first to make a move.
        </div>

        <div class="timeline" *ngIf="bids.length > 0">
          <div
            class="item"
            *ngFor="let b of bids; let i = index"
            [ngClass]="{ 'ai-bid': b.isAutoBid, 'top-item': i === 0 }"
          >
            <div class="dot" [class.top]="i === 0"></div>
            <div class="line" *ngIf="i < bids.length - 1"></div>
            <div class="card" [ngClass]="{ 'me': b.isMine, 'ai-card': b.isAutoBid }">
              <div class="row1">
                <span class="who" [class.me]="b.isMine">
                  {{
                    b.isMine
                      ? (b.isAutoBid ? 'You (AI bid)' : 'You')
                      : 'Bidder #' + (b.createdById ?? 'â€”')
                  }}
                </span>

                <span class="tag-ai" *ngIf="b.isAutoBid">
                  ðŸ¤– AI bid
                </span>

                <span class="top-pill" *ngIf="i === 0">
                  Top bid
                </span>

                <span class="amount">{{ money(b.amount) }}</span>
              </div>
              <div class="row2">
                <span class="when">{{ formatDate(b.createdDate) }}</span>
                <span class="caption">
                  <ng-container *ngIf="b.isAutoBid; else humanCaption">
                    AI boost: keeping this bid in the spotlight ðŸ¤–
                  </ng-container>
                  <ng-template #humanCaption>
                    <ng-container *ngIf="i === 0; else olderCaption">
                      Fresh move on the board ðŸ”¥
                    </ng-container>
                    <ng-template #olderCaption>
                      Logged in the bidding battle history.
                    </ng-template>
                  </ng-template>
                </span>
                <span class="status" *ngIf="b.statusName">
                  {{ b.statusName }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="panel specs">
        <h3>Vehicle details</h3>
        <div class="grid">
          <div class="row" *ngFor="let s of specs">
            <div class="label">{{ s.label }}</div>
            <div class="value">{{ s.value || 'â€”' }}</div>
          </div>
        </div>
      </section>

      <!-- Inspection Report (Tabbed per inspection type, with images) -->
      <section class="panel inspection" *ngIf="inventory">
        <h3>Inspection report</h3>

        <!-- loading state -->
        <div class="insp-loading" *ngIf="reportLoading">
          <mat-progress-bar mode="indeterminate"></mat-progress-bar>
          <span>Loading inspection reportâ€¦</span>
        </div>

        <!-- content -->
        <ng-container *ngIf="!reportLoading">
          <!-- no data -->
          <ng-container *ngIf="!reportGroups.length; else inspHasData">
            <div class="insp-empty">
              <mat-icon>content_paste_search</mat-icon>
              <div class="copy">
                <div class="title">No inspection report available yet</div>
                <div class="sub">
                  Once the vehicle has been inspected and the checklist is
                  completed, a read-only report will appear here.
                </div>
              </div>
            </div>
          </ng-container>

          <!-- has data -->
          <ng-template #inspHasData>
            <div class="insp-summary">
              <div class="tile">
                <div class="label">Total checkpoints</div>
                <div class="value">{{ totalCheckpoints }}</div>
              </div>
              <div class="tile">
                <div class="label">Completed</div>
                <div class="value">{{ totalCompleted }}</div>
              </div>
              <div class="tile">
                <div class="label">Completion</div>
                <div class="value">
                  {{ overallProgressPercent }}%
                  <span
                    class="status-pill"
                    [style.border-color]="getCompletionStatusColor()"
                  >
                    <span
                      class="dot"
                      [style.background]="getCompletionStatusColor()"
                    ></span>
                    {{ getCompletionStatus() }}
                  </span>
                </div>
              </div>
            </div>

            <mat-divider></mat-divider>

            <div class="insp-tabs-wrap">
              <mat-tab-group class="insp-tabs" animationDuration="200ms">
                <mat-tab *ngFor="let group of reportGroups">
                  <ng-template mat-tab-label>
                    <span class="insp-tab-title">
                      {{ group.inspectionTypeName }}
                    </span>
                    <span class="insp-tab-sub">
                      {{ getGroupCompleted(group) }}/{{ getGroupTotal(group) }}
                      completed
                    </span>
                  </ng-template>

                  <section class="insp-group">
                    <header class="insp-group-header">
                      <div class="left">
                        <mat-icon>fact_check</mat-icon>
                        <span class="name">{{ group.inspectionTypeName }}</span>
                        <span
                          class="weight"
                          *ngIf="
                            group.weightage != null &&
                            group.weightage !== undefined
                          "
                        >
                          {{ group.weightage }}%
                        </span>
                      </div>
                      <div class="right">
                        <span
                          class="chip"
                          [class.complete]="
                            getGroupCompleted(group) === getGroupTotal(group)
                          "
                        >
                          <mat-icon>
                            {{
                              getGroupCompleted(group) === getGroupTotal(group)
                                ? 'check_circle'
                                : 'pending'
                            }}
                          </mat-icon>
                          {{ getGroupCompleted(group) }}/{{
                            getGroupTotal(group)
                          }}
                          done
                        </span>
                      </div>
                    </header>

                    <div class="insp-checkpoints">
                      <div
                        class="insp-row"
                        *ngFor="let cp of group.checkpoints"
                        [class.answered]="isRowAnswered(cp)"
                      >
                        <div class="insp-main">
                          <div class="insp-title-row">
                            <mat-icon class="insp-status-icn">
                              {{
                                isRowAnswered(cp)
                                  ? 'check_circle'
                                  : 'radio_button_unchecked'
                              }}
                            </mat-icon>
                            <div class="insp-text">
                              <div class="insp-name">
                                {{ cp.inspectionCheckpointName }}
                              </div>
                              <div class="insp-type">
                                <span
                                  *ngIf="
                                    normalizeInputType(cp.inputType) ===
                                    'yesno'
                                  "
                                >
                                  Pass / Fail
                                </span>
                                <span
                                  *ngIf="
                                    normalizeInputType(cp.inputType) ===
                                    'number'
                                  "
                                >
                                  Numeric value
                                </span>
                                <span
                                  *ngIf="
                                    normalizeInputType(cp.inputType) ===
                                    'textarea'
                                  "
                                >
                                  Remarks
                                </span>
                                <span
                                  *ngIf="
                                    normalizeInputType(cp.inputType) ===
                                    'text'
                                  "
                                >
                                  Text
                                </span>
                                <span
                                  *ngIf="
                                    normalizeInputType(cp.inputType) ===
                                    'image'
                                  "
                                >
                                  Photos
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div class="insp-result">
                          <ng-container
                            [ngSwitch]="normalizeInputType(cp.inputType)"
                          >
                            <!-- YES/NO -->
                            <div
                              *ngSwitchCase="'yesno'"
                              class="insp-pill"
                              [class.pass]="cp.resultValue === 'Pass'"
                              [class.fail]="cp.resultValue === 'Fail'"
                            >
                              <mat-icon *ngIf="cp.resultValue === 'Pass'">
                                check_circle
                              </mat-icon>
                              <mat-icon *ngIf="cp.resultValue === 'Fail'">
                                cancel
                              </mat-icon>
                              <span>{{
                                cp.resultValue || 'Not recorded'
                              }}</span>
                            </div>

                            <!-- NUMBER -->
                            <div *ngSwitchCase="'number'" class="insp-value-box">
                              <span
                                class="value"
                                *ngIf="isAnswered(cp.resultValue); else noNumber"
                              >
                                {{ cp.resultValue }}
                              </span>
                              <ng-template #noNumber>
                                <span class="empty">No value recorded</span>
                              </ng-template>
                            </div>

                            <!-- IMAGE(S) -->
                            <div
                              *ngSwitchCase="'image'"
                              class="insp-photos-wrap"
                            >
                              <ng-container
                                *ngIf="cp.imageUrls?.length; else noPhotos"
                              >
                                <div class="insp-photos">
                                  <button
                                    type="button"
                                    class="insp-photo-thumb"
                                    *ngFor="
                                      let img of cp.imageUrls;
                                      let idx = index
                                    "
                                    (click)="openImageViewer(cp.imageUrls!, idx)"
                                    [ngStyle]="{
                                      '--photo': 'url(' + img + ')'
                                    }"
                                    matTooltip="Open photo"
                                  ></button>
                                </div>
                              </ng-container>
                              <ng-template #noPhotos>
                                <span class="empty">No photos uploaded</span>
                              </ng-template>
                            </div>

                            <!-- TEXT / TEXTAREA / DEFAULT -->
                            <div *ngSwitchDefault class="insp-notes">
                              <span
                                *ngIf="isAnswered(cp.resultValue); else noNotes"
                              >
                                {{ cp.resultValue }}
                              </span>
                              <ng-template #noNotes>
                                <span class="empty">No remarks recorded</span>
                              </ng-template>
                            </div>
                          </ng-container>
                        </div>
                      </div>
                    </div>
                  </section>
                </mat-tab>
              </mat-tab-group>
            </div>
          </ng-template>
        </ng-container>
      </section>
    </div>

    <!-- RIGHT: bidding panel -->
    <aside class="sidebar">
      <div class="rail">
        <section class="bid-panel">
          <div class="head">
            <div class="title">
              <mat-icon>gavel</mat-icon>
              <span>Live bidding</span>
            </div>
            <div class="pill" [ngClass]="auctionState">
              <span *ngIf="auctionState === 'scheduled'">Scheduled</span>
              <span *ngIf="auctionState === 'live'">Live</span>
              <span *ngIf="auctionState === 'ended'">Ended</span>
              <span *ngIf="auctionState === 'unknown'">â€”</span>
            </div>
          </div>

          <div class="current">
            <div class="label">Current price</div>
            <div class="value">
              {{ money(currentPrice ?? lotStartPrice) }}
            </div>
          </div>

          <!-- AI bidding status strip (shows when you have any AI-bid history) -->
          <div class="auto-strip" *ngIf="hasAutoBidHistory">
            <div class="left">
              <mat-icon>auto_awesome</mat-icon>
              <div class="copy">
                <div class="title">
                  AI bidding in effect
                  <span *ngIf="auctionState === 'live'"> (live)</span>
                  <span *ngIf="auctionState === 'scheduled'"> (queued)</span>
                </div>
                <div class="sub">
                  AlgoX AI will automatically nudge your bid whenever you're
                  challenged, up to your maximum.
                </div>
              </div>
            </div>
            <div class="max" *ngIf="autoBidCeiling != null">
              Max: <strong>{{ money(autoBidCeiling) }}</strong>
            </div>
          </div>

          <div class="input-row">
            <label for="bidInput">Your bid</label>
            <div class="input-wrap">
              <span class="prefix">$</span>
              <input
                id="bidInput"
                type="number"
                [(ngModel)]="newBidAmount"
                [disabled]="!isLive || placingBid"
              />
            </div>
            <div class="hint">
              <span *ngIf="lotBidIncrement">
                Min increment: {{ money(lotBidIncrement) }}
              </span>
              <span *ngIf="!lotBidIncrement">
                Enter an amount higher than current price.
              </span>
            </div>
          </div>

          <!-- AI bidding controls -->
          <div class="auto-row">
            <button
              type="button"
              class="auto-toggle"
              [class.on]="autoBidEnabled"
              (click)="toggleAutoBid()"
              [disabled]="!isLive || placingBid"
            >
              <span class="switch"></span>
              <div class="labels">
                <div class="label-main">Enable AI bidding</div>
                <div class="label-sub">
                  Let AlgoX AI keep you in the lead automatically up to your max.
                </div>
              </div>
            </button>

            <div class="auto-input" *ngIf="autoBidEnabled">
              <label for="autoMax">AI max budget</label>
              <div class="input-wrap">
                <span class="prefix">$</span>
                <input
                  id="autoMax"
                  type="number"
                  [(ngModel)]="autoBidMaxAmount"
                  [disabled]="!isLive || placingBid"
                />
              </div>
              <div class="hint">
                AI bidding will never go beyond this amount.
              </div>
            </div>
          </div>

          <div class="quick-row">
            <button
              type="button"
              class="quick"
              mat-button
              (click)="adjustBid((lotBidIncrement || 100) * 1)"
              [disabled]="!isLive || placingBid"
            >
              + 1x Increment
            </button>
            <button
              type="button"
              class="quick"
              mat-button
              (click)="adjustBid((lotBidIncrement || 100) * 2)"
              [disabled]="!isLive || placingBid"
            >
              + 2x Increment
            </button>
            <button
              type="button"
              class="quick"
              mat-button
              (click)="adjustBid((lotBidIncrement || 100) * 5)"
              [disabled]="!isLive || placingBid"
            >
              + 5x Increment
            </button>
          </div>

          <button
            type="button"
            class="primary-btn"
            (click)="placeBid()"
            [disabled]="!isLive || placingBid"
          >
            <mat-icon>gavel</mat-icon>
            <span *ngIf="isLive && !placingBid">Place bid</span>
            <span *ngIf="placingBid">Placingâ€¦</span>
            <span *ngIf="!isLive && !placingBid">Bidding closed</span>
          </button>

          <div class="footnote">
            Your bids are binding. Make sure youâ€™ve reviewed the listing
            details before placing a bid.
          </div>
        </section>

        <section class="meta-panel">
          <div class="row">
            <div class="label">Auction</div>
            <div class="value">
              {{ auction?.auctionName || ('Auction #' + auctionId) }}
            </div>
          </div>
          <div class="row">
            <div class="label">Schedule</div>
            <div class="value">
              {{
                formatRange(
                  auction?.startDateTime || null,
                  auction?.endDateTime || null
                )
              }}
            </div>
          </div>
          <div class="row">
            <div class="label">Status</div>
            <div class="value">
              {{
                auction?.auctionStatusName ||
                  auction?.auctionStatusCode ||
                  'â€”'
              }}
            </div>
          </div>
        </section>
      </div>
    </aside>
  </section>
</div>

<ng-template #busy>
  <mat-progress-bar mode="indeterminate"></mat-progress-bar>
</ng-template>

<!-- Image Viewer Modal (for inspection photos) -->
<div class="image-viewer" *ngIf="showImageViewer" (click)="closeImageViewer()">
  <div class="viewer-content" (click)="$event.stopPropagation()">
    <button class="viewer-close" (click)="closeImageViewer()">
      <mat-icon>close</mat-icon>
    </button>

    <button
      class="viewer-nav prev"
      (click)="prevImage()"
      [disabled]="selectedImageIndex === 0"
    >
      <mat-icon>chevron_left</mat-icon>
    </button>

    <div class="viewer-image">
      <img
        [src]="selectedImageGallery[selectedImageIndex]"
        alt="Inspection image"
      />
    </div>

    <button
      class="viewer-nav next"
      (click)="nextImage()"
      [disabled]="
        selectedImageIndex === selectedImageGallery.length - 1
      "
    >
      <mat-icon>chevron_right</mat-icon>
    </button>

    <div class="viewer-counter">
      {{ selectedImageIndex + 1 }} /
      {{ selectedImageGallery.length }}
    </div>
  </div>
</div>
