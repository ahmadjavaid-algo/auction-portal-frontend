<div class="bidding-theater" *ngIf="!loading; else loadingState">
  <!-- ===================== HERO BANNER (WITH RANDOM IMAGE) ===================== -->
  <header class="hero-banner" [ngStyle]="{ '--hero-img': 'url(' + bannerImage + ')' }">
    <div class="hero-overlay"></div>
    <div class="hero-noise"></div>

    <div class="hero-shell">
      <!-- Top row -->
      <div class="hero-top">
        <div class="hero-crumbs">
          <a class="crumb" routerLink="/bidder/auctions">
            <span class="dot"></span>
            Auctions
          </a>
          <span class="sep"></span>
          <a class="crumb" [routerLink]="['/bidder/auctions', auctionId]">
            <span class="dot"></span>
            {{ auction?.auctionName || ('Auction #' + auctionId) }}
          </a>
          <span class="sep"></span>
          <span class="crumb current">
            <span class="dot"></span>
            Lot #{{ lotId }}
          </span>
        </div>

        <div class="hero-pills">
          <div class="pill state" [ngClass]="auctionState">
            <span class="p-dot"></span>
            <span class="p-txt">
              {{
                auctionState === 'live'
                  ? 'LIVE'
                  : auctionState === 'scheduled'
                  ? 'SCHEDULED'
                  : auctionState === 'ended'
                  ? 'ENDED'
                  : 'UNKNOWN'
              }}
            </span>
          </div>

          <div class="pill countdown" [ngClass]="auctionState">
            <mat-icon>schedule</mat-icon>
            <span class="p-txt">{{ auctionCountdown }}</span>
          </div>
        </div>
      </div>

      <!-- Main hero content -->
      <div class="hero-main">
        <div class="hero-kicker">
          <span class="k-chip">LOT #{{ lotId }}</span>
          <span class="k-sep">•</span>
          <span class="k-auction">{{ auction?.auctionName || ('Auction #' + auctionId) }}</span>
        </div>

        <h1 class="hero-title">{{ title }}</h1>
        <div class="hero-sub">{{ subtitle }}</div>

        <div class="hero-metrics">
          <div class="metric">
            <div class="m-label">Current</div>
            <div class="m-value price">{{ money(currentPrice ?? lotStartPrice) }}</div>
            <div class="m-sub">Start {{ money(lotStartPrice) }}</div>
          </div>

          <div class="metric">
            <div class="m-label">Your Status</div>
            <div class="m-value status" [ngClass]="yourStatus.toLowerCase().replace(' ', '-')">
              <mat-icon *ngIf="yourStatus === 'Winning' || yourStatus === 'Won'">emoji_events</mat-icon>
              <mat-icon *ngIf="yourStatus === 'Outbid' || yourStatus === 'Lost'">trending_down</mat-icon>
              <mat-icon *ngIf="yourStatus === 'No Bids'">gavel</mat-icon>
              <span>{{ yourStatus }}</span>
            </div>
            <div class="m-sub" *ngIf="yourMaxBid != null">Top {{ money(yourMaxBid) }}</div>
            <div class="m-sub" *ngIf="yourMaxBid == null">No bids placed</div>
          </div>

          <div class="metric" *ngIf="lotBidIncrement">
            <div class="m-label">Increment</div>
            <div class="m-value mono">{{ money(lotBidIncrement) }}</div>
            <div class="m-sub">Minimum step</div>
          </div>

          <div class="metric" *ngIf="lotReservePrice">
            <div class="m-label">Reserve</div>
            <div class="m-value reserve" [class.met]="isReserveMet">
              <mat-icon>{{ isReserveMet ? 'check_circle' : 'info' }}</mat-icon>
              <span>{{ isReserveMet ? 'MET' : 'NOT MET' }}</span>
            </div>
            <div class="m-sub">{{ money(lotReservePrice) }}</div>
          </div>
        </div>
      </div>

      <!-- View Gallery Button -->
      <div class="hero-bottom">
        <button class="view-gallery-btn" (click)="openProductGallery()" *ngIf="images.length > 0">
          <mat-icon>photo_library</mat-icon>
          <span>View Product Gallery ({{ images.length }} {{ images.length === 1 ? 'Photo' : 'Photos' }})</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content Grid -->
  <div class="content-grid">
    <!-- Left Column: Details -->
    <div class="left-column">
      <!-- Status & Price Cards -->
      <div class="cards-row">
        <!-- Your Status Card -->
        <div class="glass-card status-card">
          <div class="card-label">Your Status</div>
          <div class="status-badge" [ngClass]="yourStatus.toLowerCase().replace(' ', '-')">
            <mat-icon *ngIf="yourStatus === 'Winning' || yourStatus === 'Won'">emoji_events</mat-icon>
            <mat-icon *ngIf="yourStatus === 'Outbid' || yourStatus === 'Lost'">trending_down</mat-icon>
            <mat-icon *ngIf="yourStatus === 'No Bids'">gavel</mat-icon>
            <span>{{ yourStatus }}</span>
          </div>
          <div class="status-details">
            <span *ngIf="yourMaxBid != null"
              >Your top bid: <strong>{{ money(yourMaxBid) }}</strong></span
            >
            <span *ngIf="yourMaxBid == null">Place your first bid below</span>
          </div>
        </div>

        <!-- Current Price Card -->
        <div class="glass-card price-card">
          <div class="card-label">Current Price</div>
          <div class="price-value">{{ money(currentPrice ?? lotStartPrice) }}</div>
          <div class="price-meta">
            <span class="meta-item">Start: {{ money(lotStartPrice) }}</span>
            <span class="meta-item" *ngIf="lotBidIncrement">Inc: {{ money(lotBidIncrement) }}</span>
          </div>
        </div>

        <!-- Reserve Card -->
        <div class="glass-card reserve-card" [class.met]="isReserveMet" *ngIf="lotReservePrice">
          <div class="card-label">Reserve</div>
          <div class="reserve-badge">
            <mat-icon>{{ isReserveMet ? 'check_circle' : 'info' }}</mat-icon>
            <span>{{ isReserveMet ? 'MET' : 'NOT MET' }}</span>
          </div>
          <div class="reserve-value">{{ money(lotReservePrice) }}</div>
        </div>
      </div>

      <!-- AI Auto-Bid Showcase (Prominent) -->
      <div class="ai-showcase" *ngIf="hasAutoBidHistory">
        <div class="ai-header">
          <div class="ai-icon">
            <mat-icon>auto_awesome</mat-icon>
          </div>
          <div class="ai-text">
            <div class="ai-title">AI Auto-Bidding Active</div>
            <div class="ai-subtitle">AlgoX AI is monitoring this auction for you</div>
          </div>
        </div>
        <div class="ai-stats">
          <div class="ai-stat">
            <div class="stat-label">Your AI Max</div>
            <div class="stat-value">{{ money(autoBidCeiling) }}</div>
          </div>
          <div class="ai-stat">
            <div class="stat-label">Status</div>
            <div class="stat-value active">{{ auctionState === 'live' ? 'LIVE' : 'QUEUED' }}</div>
          </div>
        </div>
        <div class="ai-description">
          Our AI will automatically place strategic bids on your behalf, keeping you in the lead up to your maximum
          budget. Sit back and let technology work for you.
        </div>
      </div>

      <!-- Bid History Timeline -->
      <div class="glass-card history-card">
        <div class="card-header">
          <div class="header-left">
            <mat-icon>history</mat-icon>
            <h2>Bid History</h2>
          </div>
          <div class="bid-count">{{ bids.length }} {{ bids.length === 1 ? 'Bid' : 'Bids' }}</div>
        </div>

        <div class="empty-history" *ngIf="bids.length === 0">
          <mat-icon>gavel</mat-icon>
          <span>No bids placed yet. Be the first!</span>
        </div>

        <div class="bid-timeline" *ngIf="bids.length > 0">
          <div
            class="timeline-item"
            *ngFor="let bid of bids; let i = index; let isFirst = first"
            [class.is-top]="isFirst"
            [class.is-mine]="bid.isMine"
            [class.is-ai]="bid.isAutoBid"
          >
            <div class="timeline-dot"></div>
            <div class="timeline-line" *ngIf="i < bids.length - 1"></div>

            <div class="bid-card">
              <div class="bid-header">
                <div class="bid-user">
                  <mat-icon>{{ bid.isMine ? 'person' : 'person_outline' }}</mat-icon>
                  <span>{{ bid.isMine ? 'You' : 'Bidder #' + (bid.createdById || '—') }}</span>
                  <span class="ai-badge" *ngIf="bid.isAutoBid">
                    <mat-icon>auto_awesome</mat-icon>
                    AI BID
                  </span>
                </div>
                <div class="bid-amount">{{ money(bid.amount) }}</div>
              </div>

              <div class="bid-footer">
                <span class="bid-time">{{ formatDate(bid.createdDate) }}</span>
                <span class="bid-status" *ngIf="isFirst">LEADING BID</span>
                <span class="bid-status" *ngIf="bid.statusName && !isFirst">{{ bid.statusName }}</span>
              </div>

              <div class="ai-indicator" *ngIf="bid.isAutoBid">
                <mat-icon>psychology</mat-icon>
                <span>AI placed this bid strategically</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Vehicle Specifications -->
      <div class="glass-card specs-card">
        <div class="card-header">
          <mat-icon>directions_car</mat-icon>
          <h2>Vehicle Specifications</h2>
        </div>
        <div class="specs-grid">
          <div class="spec-row" *ngFor="let spec of specs">
            <div class="spec-label">{{ spec.label }}</div>
            <div class="spec-value">{{ spec.value || '—' }}</div>
          </div>
        </div>
      </div>

      <!-- Inspection Report -->
      <div class="glass-card inspection-card" *ngIf="inventory">
        <div class="card-header">
          <mat-icon>fact_check</mat-icon>
          <h2>Inspection Report</h2>
        </div>

        <div class="inspection-loader" *ngIf="reportLoading">
          <mat-progress-bar mode="indeterminate"></mat-progress-bar>
          <span>Loading inspection data...</span>
        </div>

        <div class="inspection-empty" *ngIf="!reportLoading && reportGroups.length === 0">
          <mat-icon>content_paste_off</mat-icon>
          <div class="empty-text">
            <strong>No inspection report available</strong>
            <span>This vehicle hasn't been inspected yet</span>
          </div>
        </div>

        <div class="inspection-content" *ngIf="!reportLoading && reportGroups.length > 0">
          <!-- Summary Stats -->
          <div class="inspection-summary">
            <div class="summary-stat">
              <div class="stat-value">{{ totalCheckpoints }}</div>
              <div class="stat-label">Total Checks</div>
            </div>
            <div class="summary-stat">
              <div class="stat-value">{{ totalCompleted }}</div>
              <div class="stat-label">Completed</div>
            </div>
            <div class="summary-stat">
              <div class="stat-value">{{ overallProgressPercent }}%</div>
              <div class="stat-label">Progress</div>
            </div>
            <div class="summary-stat">
              <div class="stat-badge" [style.border-color]="getCompletionStatusColor()" [style.color]="getCompletionStatusColor()">
                {{ getCompletionStatus() }}
              </div>
            </div>
          </div>

          <mat-divider></mat-divider>

          <!-- Tabbed Sections -->
          <mat-tab-group class="inspection-tabs">
            <mat-tab *ngFor="let group of reportGroups">
              <ng-template mat-tab-label>
                <div class="tab-label">
                  <span class="tab-name">{{ group.inspectionTypeName }}</span>
                  <span class="tab-progress">{{ getGroupCompleted(group) }}/{{ getGroupTotal(group) }}</span>
                </div>
              </ng-template>

              <div class="tab-content">
                <div class="checkpoint-list">
                  <div class="checkpoint-item" *ngFor="let cp of group.checkpoints" [class.answered]="isRowAnswered(cp)">
                    <div class="checkpoint-main">
                      <mat-icon class="checkpoint-icon">
                        {{ isRowAnswered(cp) ? 'check_circle' : 'radio_button_unchecked' }}
                      </mat-icon>
                      <div class="checkpoint-text">
                        <div class="checkpoint-name">{{ cp.inspectionCheckpointName }}</div>
                        <div class="checkpoint-type">{{ normalizeInputType(cp.inputType) | uppercase }}</div>
                      </div>
                    </div>

                    <div class="checkpoint-result">
                      <!-- Yes/No -->
                      <div
                        *ngIf="normalizeInputType(cp.inputType) === 'yesno'"
                        class="result-badge"
                        [class.pass]="cp.resultValue === 'Pass'"
                        [class.fail]="cp.resultValue === 'Fail'"
                      >
                        <mat-icon>{{ cp.resultValue === 'Pass' ? 'check_circle' : 'cancel' }}</mat-icon>
                        <span>{{ cp.resultValue || 'Not recorded' }}</span>
                      </div>

                      <!-- Number -->
                      <div *ngIf="normalizeInputType(cp.inputType) === 'number'" class="result-value">
                        {{ cp.resultValue || '—' }}
                      </div>

                      <!-- Images -->
                      <div *ngIf="normalizeInputType(cp.inputType) === 'image'" class="result-images">
                        <button
                          class="image-thumb"
                          *ngFor="let img of cp.imageUrls; let idx = index"
                          [ngStyle]="{ '--img': 'url(' + img + ')' }"
                          (click)="openImageViewer(cp.imageUrls!, idx)"
                        ></button>
                        <span class="no-images" *ngIf="!cp.imageUrls?.length">No photos</span>
                      </div>

                      <!-- Text -->
                      <div
                        *ngIf="normalizeInputType(cp.inputType) === 'text' || normalizeInputType(cp.inputType) === 'textarea'"
                        class="result-text"
                      >
                        {{ cp.resultValue || 'No remarks' }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </mat-tab>
          </mat-tab-group>
        </div>
      </div>
    </div>

    <!-- Right Column: Bidding Panel (Sticky) -->
    <aside class="right-column">
      <div class="bidding-panel">
        <!-- Panel Header -->
        <div class="panel-header">
          <div class="header-icon">
            <mat-icon>gavel</mat-icon>
          </div>
          <div class="header-text">
            <h3>Place Your Bid</h3>
            <div class="auction-status" [ngClass]="auctionState">
              <span class="status-dot"></span>
              <span>{{
                auctionState === 'live'
                  ? 'LIVE BIDDING'
                  : auctionState === 'scheduled'
                  ? 'SCHEDULED'
                  : 'ENDED'
              }}</span>
            </div>
          </div>
        </div>

        <!-- Bid Amount Input -->
        <div class="bid-input-group">
          <label>Your Bid Amount</label>
          <div class="input-wrapper">
            <span class="currency">$</span>
            <input type="number" [(ngModel)]="newBidAmount" [disabled]="!isLive || placingBid" placeholder="Enter amount" />
          </div>
          <div class="input-hint">Minimum increment: {{ money(lotBidIncrement) }}</div>
        </div>

        <!-- Quick Increment Buttons -->
        <div class="quick-increments">
          <button class="increment-btn" (click)="adjustBid((lotBidIncrement || 100) * 1)" [disabled]="!isLive || placingBid">
            +{{ money((lotBidIncrement || 100) * 1) }}
          </button>
          <button class="increment-btn" (click)="adjustBid((lotBidIncrement || 100) * 2)" [disabled]="!isLive || placingBid">
            +{{ money((lotBidIncrement || 100) * 2) }}
          </button>
          <button class="increment-btn" (click)="adjustBid((lotBidIncrement || 100) * 5)" [disabled]="!isLive || placingBid">
            +{{ money((lotBidIncrement || 100) * 5) }}
          </button>
        </div>

        <mat-divider></mat-divider>

        <!-- AI Auto-Bid Toggle -->
        <div class="ai-toggle-section">
          <button class="ai-toggle" [class.enabled]="autoBidEnabled" (click)="toggleAutoBid()" [disabled]="!isLive || placingBid">
            <div class="toggle-switch">
              <span class="switch-knob"></span>
            </div>
            <div class="toggle-text">
              <div class="toggle-title">
                <mat-icon>auto_awesome</mat-icon>
                Enable AI Auto-Bidding
              </div>
              <div class="toggle-subtitle">Let our AI bid strategically for you</div>
            </div>
          </button>

          <!-- AI Max Amount Input -->
          <div class="ai-max-input" *ngIf="autoBidEnabled">
            <label>AI Maximum Budget</label>
            <div class="input-wrapper">
              <span class="currency">$</span>
              <input type="number" [(ngModel)]="autoBidMaxAmount" [disabled]="!isLive || placingBid" placeholder="Maximum amount" />
            </div>
            <div class="input-hint ai">
              <mat-icon>info</mat-icon>
              AI will never exceed this amount
            </div>
          </div>
        </div>

        <!-- Place Bid Button -->
        <button class="btn-place-bid" (click)="placeBid()" [disabled]="!isLive || placingBid">
          <span class="btn-content">
            <mat-icon>{{ placingBid ? 'hourglass_empty' : 'gavel' }}</mat-icon>
            <span *ngIf="!placingBid">{{ autoBidEnabled ? 'ACTIVATE AI BIDDING' : 'PLACE BID' }}</span>
            <span *ngIf="placingBid">PLACING BID...</span>
          </span>
        </button>

        <!-- Disclaimer -->
        <div class="bid-disclaimer">
          <mat-icon>info</mat-icon>
          <span>All bids are binding. Review details carefully before bidding.</span>
        </div>

        <!-- Auction Meta Info -->
        <div class="auction-meta">
          <div class="meta-row">
            <span class="meta-label">Auction</span>
            <span class="meta-value">{{ auction?.auctionName || 'Auction #' + auctionId }}</span>
          </div>
          <div class="meta-row">
            <span class="meta-label">Duration</span>
            <span class="meta-value">{{ formatRange(auction?.startDateTime, auction?.endDateTime) }}</span>
          </div>
          <div class="meta-row" *ngIf="lotBuyNowPrice">
            <span class="meta-label">Buy Now</span>
            <span class="meta-value highlight">{{ money(lotBuyNowPrice) }}</span>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Related lots strip -->
  <section class="related-lots" *ngIf="relatedLots.length > 0">
    <div class="related-head">
      <div class="h-left">
        <mat-icon>view_carousel</mat-icon>
        <div class="h-text">
          <h2>Related Lots</h2>
          <p>More opportunities in the same auction—tap a card to jump, or quick-bid instantly.</p>
        </div>
      </div>

      <div class="h-right">
        <div class="pill" [ngClass]="auctionState">
          <span class="dot"></span>
          <span>{{ auctionState === 'live' ? 'LIVE' : auctionState === 'scheduled' ? 'SCHEDULED' : 'ENDED' }}</span>
        </div>
      </div>
    </div>

    <div class="related-track" role="list">
      <article
        class="rel-card"
        role="listitem"
        *ngFor="let c of relatedLots"
        tabindex="0"
        (click)="openRelated(c)"
        (keydown.enter)="openRelated(c)"
      >
        <div class="rel-media" [ngStyle]="{ '--img': 'url(' + c.imageUrl + ')' }">
          <div class="rel-overlay"></div>

          <div class="rel-top">
            <div class="count" [ngClass]="c.countdownState">
              <mat-icon>schedule</mat-icon>
              <span>{{ c.countdownState === 'live' ? c.countdownText : (c.countdownText || '—') }}</span>
            </div>

            <div class="reserve" *ngIf="c.reserve != null" [class.met]="c.reserveMet">
              <mat-icon>{{ c.reserveMet ? 'check_circle' : 'info' }}</mat-icon>
              <span>{{ c.reserveMet ? 'RESERVE MET' : 'RESERVE' }}</span>
            </div>
          </div>

          <div class="rel-bottom">
            <div class="rel-title">{{ c.title }}</div>
            <div class="rel-sub">{{ c.sub }}</div>
          </div>
        </div>

        <div class="rel-meta">
          <div class="price">
            <div class="lbl">Current</div>
            <div class="val">{{ money(c.currentPrice ?? c.auctionStartPrice) }}</div>
          </div>

          <button
            class="quickbid"
            (click)="onQuickBidRelated(c, $event)"
            [disabled]="!isLive || c.placingBid || c.bidCooldownActive"
          >
            <mat-icon>{{ c.placingBid ? 'hourglass_empty' : 'flash_on' }}</mat-icon>
            <span *ngIf="!c.bidCooldownActive && !c.placingBid">Quick Bid</span>
            <span *ngIf="c.bidCooldownActive && !c.placingBid">Wait {{ c.bidCooldownRemaining }}s</span>
            <span *ngIf="c.placingBid">Placing…</span>
          </button>
        </div>

        <div class="rel-foot">
          <div class="inc" *ngIf="c.bidIncrement != null">
            <mat-icon>north</mat-icon>
            <span>Inc {{ money(c.bidIncrement) }}</span>
          </div>

          <div class="tap">
            <mat-icon>open_in_new</mat-icon>
            <span>Open lot</span>
          </div>
        </div>
      </article>
    </div>
  </section>
</div>

<!-- Loading State -->
<ng-template #loadingState>
  <div class="loading-screen">
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
    <span>Loading auction details...</span>
  </div>
</ng-template>

<!-- Error State -->
<div class="error-screen" *ngIf="error && !loading">
  <mat-icon>error_outline</mat-icon>
  <h2>{{ error }}</h2>
  <button class="btn-back" routerLink="/bidder/auctions">
    <mat-icon>arrow_back</mat-icon>
    <span>Back to Auctions</span>
  </button>
</div>

<!-- PROFESSIONAL IMAGE VIEWER MODAL -->
<div class="image-viewer-modal" *ngIf="showImageViewer" (click)="closeImageViewer()">
  <div class="viewer-backdrop"></div>
  
  <div class="viewer-container" (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="viewer-header">
      <div class="viewer-title">
        <mat-icon>photo_library</mat-icon>
        <span>Product Gallery</span>
        <span class="viewer-counter">{{ selectedImageIndex + 1 }} / {{ selectedImageGallery.length }}</span>
      </div>
      <button class="viewer-close" (click)="closeImageViewer()" aria-label="Close viewer">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Main Image Display -->
    <div class="viewer-main">
      <button 
        class="viewer-nav prev" 
        (click)="prevImage()" 
        [disabled]="selectedImageIndex === 0"
        aria-label="Previous image"
      >
        <mat-icon>chevron_left</mat-icon>
      </button>

      <div class="viewer-image-wrapper">
        <img 
          [src]="selectedImageGallery[selectedImageIndex]" 
          alt="Product photo {{ selectedImageIndex + 1 }}" 
          class="viewer-image"
        />
      </div>

      <button 
        class="viewer-nav next" 
        (click)="nextImage()" 
        [disabled]="selectedImageIndex === selectedImageGallery.length - 1"
        aria-label="Next image"
      >
        <mat-icon>chevron_right</mat-icon>
      </button>
    </div>

    <!-- Thumbnail Strip -->
    <div class="viewer-thumbnails" *ngIf="selectedImageGallery.length > 1">
      <div class="thumbnails-track">
        <button
          *ngFor="let img of selectedImageGallery; let idx = index"
          class="thumbnail"
          [class.active]="idx === selectedImageIndex"
          [ngStyle]="{ '--thumb-img': 'url(' + img + ')' }"
          (click)="selectedImageIndex = idx"
          [attr.aria-label]="'View image ' + (idx + 1)"
        >
          <div class="thumbnail-overlay" *ngIf="idx === selectedImageIndex"></div>
        </button>
      </div>
    </div>

    <!-- Footer Info -->
    <div class="viewer-footer">
      <div class="viewer-info">
        <mat-icon>info</mat-icon>
        <span>Use arrow keys or click thumbnails to navigate</span>
      </div>
      <div class="viewer-actions">
        <button class="viewer-action-btn" (click)="prevImage()" [disabled]="selectedImageIndex === 0">
          <mat-icon>arrow_back</mat-icon>
          <span>Previous</span>
        </button>
        <button class="viewer-action-btn" (click)="nextImage()" [disabled]="selectedImageIndex === selectedImageGallery.length - 1">
          <span>Next</span>
          <mat-icon>arrow_forward</mat-icon>
        </button>
      </div>
    </div>
  </div>
</div>