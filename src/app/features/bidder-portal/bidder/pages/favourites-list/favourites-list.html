<div class="favourites">
  <!-- breadcrumbs -->
  <div class="crumbs">
    <a routerLink="/bidder/dashboard">Home</a>
    <mat-icon>chevron_right</mat-icon>
    <span class="current">Favourites</span>
    <span class="count" *ngIf="!loading">({{ results.length }} lots)</span>
  </div>

  <!-- hero -->
  <section class="hero" [ngStyle]="{ '--photo': 'url(' + heroUrl + ')' }">
    <div class="overlay">
      <h1>Your Favourites</h1>
      <div class="meta">
        <div class="lots">
          <mat-icon>favorite</mat-icon>
          <span>{{ results.length }} saved lots</span>
        </div>
      </div>
    </div>
  </section>

  <mat-progress-bar *ngIf="loading" mode="indeterminate"></mat-progress-bar>

  <div class="err" *ngIf="!loading && error">
    <mat-icon>error_outline</mat-icon>
    <span>{{ error }}</span>
  </div>

  <!-- toolbar -->
  <div class="toolbar" *ngIf="!loading && !error">
    <div class="searchbar">
      <mat-icon>search</mat-icon>
      <input
        type="text"
        placeholder="Search car, auction, chassis, make, model…"
        [(ngModel)]="q"
      />
      <button
        *ngIf="q"
        class="clear"
        (click)="q = ''"
        matTooltip="Clear"
      >
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="select">
      <label>Auction</label>
      <select [(ngModel)]="filters.auction">
        <option value="">All</option>
        <option *ngFor="let a of options.auctions" [value]="a">
          {{ a }}
        </option>
      </select>
    </div>

    <div class="select">
      <label>Make</label>
      <select [(ngModel)]="filters.make">
        <option value="">All</option>
        <option *ngFor="let m of options.makes" [value]="m">
          {{ m }}
        </option>
      </select>
    </div>

    <div class="select">
      <label>Model</label>
      <select [(ngModel)]="filters.model">
        <option value="">All</option>
        <option *ngFor="let m of options.models" [value]="m">
          {{ m }}
        </option>
      </select>
    </div>

    <div class="select">
      <label>Year</label>
      <select [(ngModel)]="filters.year">
        <option value="">All</option>
        <option *ngFor="let y of options.years" [value]="y">
          {{ y }}
        </option>
      </select>
    </div>

    <div class="select">
      <label>Category</label>
      <select [(ngModel)]="filters.category">
        <option value="">All</option>
        <option *ngFor="let c of options.categories" [value]="c">
          {{ c }}
        </option>
      </select>
    </div>

    <div class="select">
      <label>Sort</label>
      <select [(ngModel)]="sortBy">
        <option value="newest">Newest</option>
        <option value="start_time">Auction Start Time</option>
        <option value="price_low">Price: Low → High</option>
        <option value="price_high">Price: High → Low</option>
        <option value="year_new">Year: Newest</option>
        <option value="year_old">Year: Oldest</option>
      </select>
    </div>

    <button
      class="link clear-all"
      (click)="clearAll()"
      *ngIf="
        q ||
        filters.auction ||
        filters.make ||
        filters.model ||
        filters.year ||
        filters.category ||
        sortBy !== 'newest'
      "
    >
      Clear all
    </button>
  </div>

  <!-- grid -->
  <div class="grid" *ngIf="!loading && !error">
    <article
      class="lot-card"
      *ngFor="let c of results; trackBy: trackById"
      [ngStyle]="{ '--photo': 'url(' + c.imageUrl + ')' }"
    >
      <div class="photo">
        <!-- countdown pill -->
        <div
          class="timer-pill"
          [class.live]="c.countdownState === 'live'"
          [class.ended]="c.countdownState === 'ended'"
        >
          <mat-icon inline>schedule</mat-icon>
          <span>{{ c.countdownText || '—' }}</span>
        </div>

        <!-- favourite toggle -->
        <button
          class="fav-pill"
          [class.active]="c.isFavourite"
          (click)="toggleFavourite(c)"
          matTooltip="{{
            c.isFavourite ? 'Remove from favourites' : 'Add to favourites'
          }}"
          type="button"
        >
          <mat-icon>{{
            c.isFavourite ? 'favorite' : 'favorite_border'
          }}</mat-icon>
        </button>
      </div>

      <div class="body">
        <div class="auction-chip" *ngIf="c.auctionName">
          <mat-icon>event</mat-icon>
          <span>{{ c.auctionName }}</span>
        </div>

        <h3 class="title">{{ c.title }}</h3>
        <div class="sub">{{ c.sub }}</div>

        <div class="numbers">
          <div class="num" *ngIf="c.auctionStartPrice != null">
            <div class="label">Start Price</div>
            <div class="value">
              {{ c.auctionStartPrice | currency: 'USD':'symbol':'1.0-0' }}
            </div>
          </div>
          <div class="num" *ngIf="c.reserve != null">
            <div class="label">Reserve</div>
            <div class="value">
              {{ c.reserve | currency: 'USD':'symbol':'1.0-0' }}
            </div>
          </div>
          <div class="num" *ngIf="c.buyNow != null">
            <div class="label">Buy Now</div>
            <div class="value">
              {{ c.buyNow | currency: 'USD':'symbol':'1.0-0' }}
            </div>
          </div>
          <div class="num" *ngIf="c.bidIncrement != null">
            <div class="label">Bid Increment</div>
            <div class="value">
              {{ c.bidIncrement | currency: 'USD':'symbol':'1.0-0' }}
            </div>
          </div>
        </div>

        <!-- bidding metrics like auctions-details card -->
        <div class="bid-metrics">
          <div class="metric">
            <div class="label">Current Bid</div>
            <div class="value">
              <ng-container *ngIf="c.currentPrice != null; else noCurrent">
                {{ c.currentPrice | currency: 'USD':'symbol':'1.0-0' }}
              </ng-container>
              <ng-template #noCurrent>—</ng-template>
            </div>
          </div>

          <div class="metric">
            <div class="label">Your Max</div>
            <div
              class="value"
              [class.outbid]="
                c.yourMaxBid != null &&
                c.currentPrice != null &&
                c.yourMaxBid < c.currentPrice
              "
            >
              <ng-container *ngIf="c.yourMaxBid != null; else noYourMax">
                {{ c.yourMaxBid | currency: 'USD':'symbol':'1.0-0' }}
              </ng-container>
              <ng-template #noYourMax>—</ng-template>
            </div>

            <div class="tag" *ngIf="c.yourMaxBid != null">
              <ng-container
                *ngIf="
                  c.currentPrice != null && c.yourMaxBid >= c.currentPrice;
                  else outbidTag
                "
              >
                <span class="pill winning">
                  <span class="dot"></span>
                  Winning
                </span>
              </ng-container>
              <ng-template #outbidTag>
                <span class="pill outbid">
                  <span class="dot"></span>
                  Outbid
                </span>
              </ng-template>
            </div>
          </div>

          <div class="metric reserve" *ngIf="c.reserve != null">
            <div class="label">Reserve Status</div>
            <div
              class="pill"
              [class.met]="c.reserveMet"
              [class.not-met]="!c.reserveMet"
            >
              <span class="dot"></span>
              <span>{{ c.reserveMet ? 'Reserve met' : 'Reserve not met' }}</span>
            </div>
          </div>
        </div>

        <div class="actions">
          <!-- quick bid button -->
          <button
            type="button"
            class="btn primary quick"
            (click)="onQuickBid(c)"
            [disabled]="
              c.bidCooldownActive ||
              c.placingBid ||
              c.countdownState !== 'live'
            "
            matTooltip="Place a quick bid on this lot"
          >
            <mat-icon *ngIf="!c.bidCooldownActive && !c.placingBid">
              bolt
            </mat-icon>
            <mat-icon *ngIf="c.placingBid">hourglass_top</mat-icon>

            <span *ngIf="!c.bidCooldownActive && !c.placingBid">
              Quick bid
            </span>
            <span *ngIf="c.bidCooldownActive && !c.placingBid">
              Confirm ({{ c.bidCooldownRemaining }}s)
            </span>
            <span *ngIf="c.placingBid">Placing…</span>
          </button>

          <!-- cancel quick bid -->
          <button
            type="button"
            class="btn ghost"
            *ngIf="c.bidCooldownActive && !c.placingBid"
            (click)="cancelQuickBid(c)"
          >
            Cancel
          </button>

          <!-- view details -->
          <a
            class="btn ghost"
            [routerLink]="[
              '/bidder/auctions',
              c.auctionId,
              c.inventoryAuctionId
            ]"
            matTooltip="View full details & place a custom bid"
          >
            View details
          </a>
        </div>
      </div>
    </article>

    <div class="empty" *ngIf="results.length === 0">
      <mat-icon>info</mat-icon>
      <span>You haven’t favourited any lots yet.</span>
    </div>
  </div>
</div>
