<div class="dashboard-page">
  <!-- Hero -->
  <section class="hero">
    <div class="hero-left">
      <div class="wave">
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
      </div>
      <div class="title">
        <h1>Welcome back, {{ adminName }}</h1>
        <p class="sub">
          Your car auctions at a glance — live traffic, bids and verifications.
        </p>
      </div>
    </div>

    <div class="hero-actions">
      <button
        mat-stroked-button
        class="ghost"
        matTooltip="Schedule a new auction"
      >
        <mat-icon>calendar_month</mat-icon>
        Schedule Auction
      </button>
      <button
        mat-flat-button
        class="cta"
        matTooltip="List a new vehicle"
      >
        <mat-icon>add_circle</mat-icon>
        Add Vehicle
      </button>
    </div>
  </section>

  <!-- KPI Tiles -->
  <section class="stats-grid">
    <div
      class="stat-card"
      *ngFor="let s of stats; let i = index"
      [style.--i]="i"
    >
      <div class="icon-wrap"><mat-icon>{{ s.icon }}</mat-icon></div>
      <div class="meta">
        <div class="value">
          <span class="count-up" [attr.data-value]="s.value || 0">
            {{ s.value || 0 }}
          </span>
        </div>
        <div class="label">{{ s.label }}</div>
      </div>
      <div class="trend" [class.up]="s.up" [class.down]="!s.up">
        <mat-icon>{{ s.up ? 'trending_up' : 'trending_down' }}</mat-icon>
        <span>{{ s.delta }}</span>
      </div>

      <svg
        class="spark"
        viewBox="0 0 100 32"
        preserveAspectRatio="none"
        aria-hidden="true"
      >
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="0">
            <stop offset="0" stop-color="var(--brand-500)" />
            <stop offset="1" stop-color="var(--teal-500)" />
          </linearGradient>
        </defs>
        <path
          d="M0,22 L12,18 L22,24 L32,12 L42,16 L55,10 L68,14 L82,8 L100,12"
          stroke="url(#g)"
          fill="none"
          stroke-width="2"
        />
      </svg>
    </div>
  </section>

  <!-- Main Grid -->
  <section class="main-grid">
    <!-- Left column: Auctions at a Glance -->
    <div class="panel live-auctions">
      <div class="panel-h">
        <h3>
          <mat-icon>local_fire_department</mat-icon>
          Auctions at a Glance
        </h3>

        <!-- Only show toggle if there are more than 5 rows -->
        <button
          mat-stroked-button
          class="mini"
          *ngIf="liveAuctions.length > 5"
          (click)="toggleGlance()"
        >
          <mat-icon>visibility</mat-icon>
          {{ glanceExpanded ? 'Collapse' : 'View all' }}
        </button>
      </div>

      <div class="busy" *ngIf="glanceLoading">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      </div>

      <!-- rows: AU-xx | Make+Count | Live/Scheduled -->
      <ul
        class="auction-list"
        *ngIf="!glanceLoading && liveAuctions.length; else noGlance"
      >
        <li *ngFor="let a of visibleGlanceAuctions">
          <!-- Auction number -->
          <div class="id mono">{{ a.lot }}</div>

          <!-- Make + car icon + count (single line) -->
          <div class="make-col">
            <span class="car">{{ a.make }}</span>
            <span class="bids">
              <mat-icon>directions_car</mat-icon>
              <span>{{ a.count }}</span>
            </span>
          </div>

          <!-- Status pill: Live / Scheduled (single line) -->
          <div
            class="status"
            [class.live]="a.status === 'Live'"
            [class.scheduled]="a.status === 'Scheduled'"
          >
            {{ a.status }}
          </div>
        </li>
      </ul>

      <ng-template #noGlance>
        <div class="notif-empty" style="padding: 16px">
          <mat-icon>notifications_none</mat-icon>
          <span>No auctions to show yet.</span>
        </div>
      </ng-template>
    </div>

    <!-- Performance -->
    <div class="panel performance">
      <div class="panel-h">
        <h3><mat-icon>insights</mat-icon> Revenue Performance</h3>
      </div>
      <div class="perf-grid">
        <div class="big-number">
          <div class="caption">Total Revenue</div>
          <div class="num">
            {{ totalRevenue | number : '1.0-0' }}
          </div>

          <div class="chip" [class.up]="revenueTodaySharePercent > 0">
            <mat-icon>
              {{ revenueTodaySharePercent > 0 ? 'north_east' : 'horizontal_rule' }}
            </mat-icon>
            <ng-container
              *ngIf="totalRevenue > 0 && revenueToday > 0; else noRevChip"
            >
              {{ revenueTodaySharePercent }}% of total today
            </ng-container>
            <ng-template #noRevChip>
              No revenue yet today
            </ng-template>
          </div>
        </div>

        <svg
          class="big-spark"
          viewBox="0 0 220 80"
          preserveAspectRatio="none"
        >
          <defs>
            <linearGradient id="gg" x1="0" y1="0" x2="1" y2="0">
              <stop offset="0" stop-color="var(--brand-500)" />
              <stop offset="1" stop-color="var(--teal-500)" />
            </linearGradient>
          </defs>
          <path
            d="M0,60 L24,56 L44,62 L64,40 L84,46 L110,30 L136,42 L168,28 L220,36"
            stroke="url(#gg)"
            fill="none"
            stroke-width="3"
          />
        </svg>

        <div class="mini-kpis">
          <div class="mini">
            <div class="label">Revenue Today</div>
            <div class="val">{{ revenueToday | number : '1.0-0' }}</div>
          </div>
          <div class="mini">
            <div class="label">Bids Today (1d) </div>
            <div class="val">{{ bidsToday | number : '1.0-0' }}</div>
          </div>
          <div class="mini">
            <div class="label">Live Auctions</div>
            <div class="val">{{ liveAuctionCount | number : '1.0-0' }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right column: Verification Queue -->
    <div class="panel kyc">
      <div class="panel-h">
        <h3><mat-icon>pending_actions</mat-icon> Verification Queue</h3>
        <button
          mat-stroked-button
          class="mini"
          (click)="loadUnverifiedBidders()"
          matTooltip="Refresh"
        >
          <mat-icon>refresh</mat-icon>
          Refresh
        </button>
      </div>

      <div class="busy" *ngIf="kycLoading">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      </div>

      <ul
        class="queue"
        *ngIf="!kycLoading && unverifiedBidders.length; else emptyQueue"
      >
        <li *ngFor="let u of unverifiedBidders">
          <div
            class="avatar"
            [style.background]="
              'linear-gradient(135deg, var(--brand-500), var(--teal-500))'
            "
          >
            {{ getFullName(u) | slice : 0 : 1 }}
          </div>
          <div class="who">
            <div class="name">{{ getFullName(u) }}</div>
            <div class="sub">{{ u.email || u.userName }}</div>
          </div>

          <div
            class="age muted"
            [title]="u.createdDate ? (u.createdDate | date: 'yyyy-MM-dd HH:mm') : ''"
          >
            {{ u.createdDate ? toRelative(u.createdDate) : '—' }}
          </div>
        </li>
      </ul>

      <ng-template #emptyQueue>
        <div class="notif-empty" style="padding: 16px">
          <mat-icon>verified_user</mat-icon>
          <span>Great! No unverified bidders.</span>
        </div>
      </ng-template>
    </div>

    <!-- Top Bidders -->
    <div class="panel bidders">
      <div class="panel-h">
        <h3><mat-icon>leaderboard</mat-icon> Top Bidders Today</h3>
      </div>

      <!-- loading state -->
      <div class="busy" *ngIf="topBiddersLoading">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      </div>

      <!-- list -->
      <ul
        class="tops"
        *ngIf="!topBiddersLoading && topBidders.length; else noTopBidders"
      >
        <li *ngFor="let b of topBidders; let i = index">
          <div class="rank">#{{ i + 1 }}</div>
          <div class="dot" [style.background]="b.color"></div>
          <div class="who">
            <div class="name">{{ b.name }}</div>
            <div class="sub">{{ b.handle }}</div>
          </div>
          <div class="bcount chip">
            <mat-icon>gavel</mat-icon>
            {{ b.bids }}
          </div>
        </li>
      </ul>

      <ng-template #noTopBidders>
        <div class="notif-empty" style="padding: 16px">
          <mat-icon>gavel</mat-icon>
          <span>No bids placed today yet.</span>
        </div>
      </ng-template>
    </div>

    <!-- Recent Activity -->
    <div class="panel activity">
      <div class="panel-h">
        <h3><mat-icon>history</mat-icon> Recent Activity</h3>
        <button
          mat-stroked-button
          class="mini"
          (click)="toggleRecentActivity()"
          [attr.aria-expanded]="!activityCollapsed"
        >
          <mat-icon>
            {{ activityCollapsed ? 'unfold_more' : 'unfold_less' }}
          </mat-icon>
          {{ activityCollapsed ? 'Show all' : 'Show less' }}
        </button>
      </div>

      <div class="busy" *ngIf="activityLoading">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      </div>

      <ul
        class="timeline"
        *ngIf="!activityLoading && activity.length; else noActivity"
      >
        <li *ngFor="let a of (activityCollapsed ? activity.slice(0, 3) : activity)">
          <div class="bullet"><mat-icon>{{ a.icon }}</mat-icon></div>
          <div class="text">{{ a.text }}</div>
          <div class="time muted">{{ a.time }}</div>
        </li>
      </ul>

      <ng-template #noActivity>
        <div class="notif-empty" style="padding: 16px">
          <mat-icon>history</mat-icon>
          <span>No recent activity yet.</span>
        </div>
      </ng-template>
    </div>

    <!-- Bidder Funnel (replaces System Health) -->
    <div class="panel bidder-funnel">
      <div class="panel-h">
        <h3><mat-icon>groups</mat-icon> Bidder Funnel</h3>
      </div>

      <div class="funnel-grid" *ngIf="totalBidders > 0; else noBiddersState">
        <div class="funnel-main">
          <div class="funnel-number">
            <div class="caption">Verified Bidders</div>
            <div class="num">
              {{ verifiedBidders | number : '1.0-0' }}
            </div>
          </div>

          <div class="funnel-meter">
            <div class="meter-bg">
              <div
                class="meter-fill"
                [style.width.%]="verificationRate"
              ></div>
            </div>
            <div class="meter-label">
              {{ verificationRate }}% verified of
              {{ totalBidders | number : '1.0-0' }}
            </div>
          </div>
        </div>

        <div class="funnel-side">
          <div class="mini">
            <div class="label">Pending KYC</div>
            <div class="value">
              {{ unverifiedBidders.length | number : '1.0-0' }}
            </div>
          </div>
          <div class="mini">
            <div class="label">New Signups (7d)</div>
            <div class="value">
              {{ recentSignups7d | number : '1.0-0' }}
            </div>
          </div>
        </div>
      </div>

      <ng-template #noBiddersState>
        <div class="notif-empty small">
          <mat-icon>person_add</mat-icon>
          <span>No bidders registered yet.</span>
        </div>
      </ng-template>
    </div>
  </section>
</div>
