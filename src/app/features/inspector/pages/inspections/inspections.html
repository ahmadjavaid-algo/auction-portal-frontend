<!-- src/app/pages/inspector/inspections/inspections.html -->
<div class="inspections-page">
  <!-- Loading State -->
  <div class="loading-state" *ngIf="loading">
    <mat-spinner diameter="48"></mat-spinner>
    <span>Loading your inspections...</span>
  </div>

  <!-- Error State -->
  <div class="error-state" *ngIf="!loading && error">
    <mat-icon>error_outline</mat-icon>
    <div class="error-content">
      <h3>Something went wrong</h3>
      <p>{{ error }}</p>
    </div>
  </div>

  <!-- Main Content -->
  <ng-container *ngIf="!loading && !error">
    <!-- Page Header -->
    <header class="page-header">
      <div class="header-content">
        <div class="header-badge">
          <span class="badge-dot"></span>
          <span>Inspector Workspace</span>
        </div>
        <h1>Vehicle Inspections</h1>
        <p class="header-subtitle">
          Complete detailed inspections for all assigned vehicles
        </p>
      </div>

      <div class="header-stats" *ngIf="blocks.length">
        <div class="stat-box">
          <div class="stat-icon" style="background: #3b82f6;">
            <mat-icon>directions_car</mat-icon>
          </div>
          <div class="stat-content">
            <span class="stat-value">{{ blocks.length }}</span>
            <span class="stat-label">Vehicles</span>
          </div>
        </div>

        <div class="stat-box">
          <div class="stat-icon" style="background: #22c55e;">
            <mat-icon>fact_check</mat-icon>
          </div>
          <div class="stat-content">
            <span class="stat-value">{{ totalCompleted }}</span>
            <span class="stat-label">Completed</span>
          </div>
        </div>

        <div class="stat-box">
          <div class="stat-icon" style="background: #f59e0b;">
            <mat-icon>pending_actions</mat-icon>
          </div>
          <div class="stat-content">
            <span class="stat-value">{{ totalCheckpoints - totalCompleted }}</span>
            <span class="stat-label">Remaining</span>
          </div>
        </div>

        <div class="stat-box gradient">
          <div class="progress-circle">
            <svg viewBox="0 0 36 36">
              <path
                class="circle-bg"
                d="M18 2.0845
                  a 15.9155 15.9155 0 0 1 0 31.831
                  a 15.9155 15.9155 0 0 1 0 -31.831"
              ></path>
              <path
                class="circle-progress"
                [attr.stroke-dasharray]="(totalCheckpoints ? (totalCompleted / totalCheckpoints) * 100 : 0) + ', 100'"
                d="M18 2.0845
                  a 15.9155 15.9155 0 0 1 0 31.831
                  a 15.9155 15.9155 0 0 1 0 -31.831"
              ></path>
            </svg>
            <div class="progress-text">
              {{ (totalCheckpoints ? (totalCompleted / totalCheckpoints) * 100 : 0) | number:'1.0-0' }}%
            </div>
          </div>
          <span class="stat-label">Overall Progress</span>
        </div>
      </div>
    </header>

    <!-- Inventory Quick Shortcuts -->
    <section
      class="inventory-shortcuts"
      *ngIf="blocks.length"
    >
      <div class="shortcuts-label">
        <mat-icon>view_carousel</mat-icon>
        <span>Quick access to assigned vehicles</span>
      </div>

      <div class="shortcuts-row">
        <button
          type="button"
          class="shortcut-card"
          *ngFor="let block of blocks"
          (click)="scrollToInventory(block.inventory.inventoryId)"
          matTooltip="Jump to {{ block.productName }}"
        >
          <div class="shortcut-image-wrapper">
            <ng-container *ngIf="block.images && block.images.length; else noImageThumb">
              <div class="shortcut-image">
                <img [src]="block.images[0]" [alt]="block.productName" />
              </div>
            </ng-container>
            <ng-template #noImageThumb>
              <div class="shortcut-placeholder">
                <mat-icon>directions_car</mat-icon>
              </div>
            </ng-template>
          </div>
          <div class="shortcut-text">
            <span class="shortcut-name">
              {{ block.productName }}
            </span>
            <span class="shortcut-meta">
              {{ block.registrationNo }}
            </span>
          </div>
        </button>
      </div>
    </section>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="!blocks.length">
      <div class="empty-icon">
        <mat-icon>inventory_2</mat-icon>
      </div>
      <h3>No Vehicles Assigned</h3>
      <p>You don't have any vehicles assigned for inspection yet. Check back later or contact your administrator.</p>
    </div>

    <!-- Vehicle Cards -->
    <div class="vehicles-grid" *ngIf="blocks.length">
      <article
        class="vehicle-card"
        *ngFor="let block of blocks"
        [attr.id]="'inv-' + block.inventory.inventoryId"
      >
        <!-- Card Header -->
        <div class="card-header">
          <div class="header-top">
            <div class="vehicle-info">
              <span class="inventory-badge">
                INV-{{ block.inventory.inventoryId }}
              </span>
              <h2 class="vehicle-title">{{ block.productName }}</h2>
              <p class="vehicle-meta">{{ block.productMeta }}</p>
            </div>

            <div class="status-badge" [style.background]="getStatusColor(getBlockStatus(block))">
              <span class="status-dot"></span>
              <span>{{ getBlockStatus(block) }}</span>
            </div>
          </div>

          <!-- Vehicle Details -->
          <div class="vehicle-details">
            <div class="detail-item">
              <mat-icon>confirmation_number</mat-icon>
              <div class="detail-content">
                <span class="detail-label">Registration</span>
                <span class="detail-value">{{ block.registrationNo }}</span>
              </div>
            </div>

            <div class="detail-item">
              <mat-icon>pin</mat-icon>
              <div class="detail-content">
                <span class="detail-label">Chassis</span>
                <span class="detail-value">{{ block.chassisNo }}</span>
              </div>
            </div>

            <div class="detail-item">
              <mat-icon>check_circle</mat-icon>
              <div class="detail-content">
                <span class="detail-label">Progress</span>
                <span class="detail-value">{{ getBlockCompleted(block) }}/{{ getBlockTotal(block) }} Checks</span>
              </div>
            </div>
          </div>

          <!-- Progress Bar -->
          <div class="progress-bar">
            <div class="progress-track">
              <div
                class="progress-fill"
                [style.width.%]="getBlockProgressPercent(block)"
              ></div>
            </div>
            <span class="progress-label">{{ getBlockProgressPercent(block) }}% Complete</span>
          </div>

          <!-- Image Gallery -->
          <div class="image-gallery" *ngIf="block.images && block.images.length">
            <div class="gallery-label">
              <mat-icon>photo_library</mat-icon>
              <span>{{ block.images.length }} Photos Available</span>
            </div>

            <div class="gallery-grid">
              <div
                class="gallery-item"
                *ngFor="let img of block.images | slice:0:4; let i = index"
                (click)="openImageGallery(block.images, i)"
              >
                <img [src]="img" [alt]="block.productName" />
                <div class="gallery-overlay" *ngIf="i === 3 && block.images.length > 4">
                  <mat-icon>add</mat-icon>
                  <span>{{ block.images.length - 4 }} more</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="card-actions">
            <button
              mat-stroked-button
              class="expand-btn"
              (click)="toggleExpanded(block)"
            >
              <mat-icon>{{ block.expanded ? 'expand_less' : 'expand_more' }}</mat-icon>
              <span>{{ block.expanded ? 'Hide' : 'Show' }} Inspection Form</span>
            </button>

            <span class="completion-badge">
              <mat-icon>checklist</mat-icon>
              {{ getBlockCompleted(block) }}/{{ getBlockTotal(block) }}
            </span>
          </div>
        </div>

        <!-- Inspection Form -->
        <div class="card-body" *ngIf="block.expanded">
          <div class="form-header">
            <mat-icon>rule</mat-icon>
            <div class="form-header-text">
              <h3>Inspection Checklist</h3>
              <p>Complete all checkpoints for this vehicle</p>
            </div>
          </div>

          <!-- Inspection Groups -->
          <div class="inspection-groups">
            <div
              class="inspection-group"
              *ngFor="let group of block.groups"
            >
              <div class="group-header">
                <div class="group-title">
                  <mat-icon>category</mat-icon>
                  <span>{{ group.inspectionTypeName }}</span>
                  <span class="group-weight" *ngIf="group.weightage">{{ group.weightage }}%</span>
                </div>

                <div class="group-progress">
                  <span
                    class="progress-chip"
                    [class.complete]="getGroupCompleted(group) === group.checkpoints.length"
                  >
                    <mat-icon>{{ getGroupCompleted(group) === group.checkpoints.length ? 'check_circle' : 'pending' }}</mat-icon>
                    <span>{{ getGroupCompleted(group) }}/{{ group.checkpoints.length }}</span>
                  </span>
                </div>
              </div>

              <!-- Checkpoints -->
              <div class="checkpoints-list">
                <div
                  class="checkpoint-item"
                  *ngFor="let row of group.checkpoints"
                  [class.answered]="isRowAnswered(row)"
                >
                  <div class="checkpoint-label">
                    <div class="label-main">
                      <mat-icon class="check-icon">
                        {{ isRowAnswered(row) ? 'check_circle' : 'radio_button_unchecked' }}
                      </mat-icon>
                      <span>{{ row.inspectionCheckpointName }}</span>
                    </div>
                    <span class="label-hint" *ngIf="normalizeInputType(row.inputType) === 'yesno'">
                      Select Pass or Fail
                    </span>
                    <span class="label-hint" *ngIf="normalizeInputType(row.inputType) === 'number'">
                      Enter numeric value
                    </span>
                    <span class="label-hint" *ngIf="normalizeInputType(row.inputType) === 'textarea'">
                      Provide detailed notes
                    </span>
                    <span class="label-hint" *ngIf="normalizeInputType(row.inputType) === 'image'">
                      Upload clear images (multiple allowed)
                    </span>
                  </div>

                  <div class="checkpoint-input">
                    <ng-container [ngSwitch]="normalizeInputType(row.inputType)">

                      <!-- Textarea -->
                      <textarea
                        *ngSwitchCase="'textarea'"
                        [(ngModel)]="row.resultValue"
                        rows="3"
                        placeholder="Enter detailed observations..."
                        class="form-textarea"
                      ></textarea>

                      <!-- Number ONLY (InputType = Number) -->
                      <input
                        *ngSwitchCase="'number'"
                        type="number"
                        [(ngModel)]="row.resultValue"
                        placeholder="Enter value..."
                        class="form-input"
                      />

                      <!-- Yes/No Toggle -->
                      <div *ngSwitchCase="'yesno'" class="yesno-buttons">
                        <button
                          type="button"
                          class="yesno-btn pass"
                          [class.active]="row.resultValue === 'Pass'"
                          (click)="setYesNo(row, 'Pass')"
                        >
                          <mat-icon>check_circle</mat-icon>
                          <span>Pass</span>
                        </button>
                        <button
                          type="button"
                          class="yesno-btn fail"
                          [class.active]="row.resultValue === 'Fail'"
                          (click)="setYesNo(row, 'Fail')"
                        >
                          <mat-icon>cancel</mat-icon>
                          <span>Fail</span>
                        </button>
                      </div>

                    <!-- IMAGE upload (InputType = Image) -->
<div *ngSwitchCase="'image'" class="checkpoint-image-field">
  <label class="image-upload-btn">
    <input
      type="file"
      accept="image/*"
      multiple
      (change)="uploadCheckpointImages(block, group, row, $event)"
    />
    <div class="upload-icon">
      <mat-icon>cloud_upload</mat-icon>
    </div>
    <div class="upload-text">
      <span class="upload-title">Upload inspection photos</span>
      <span class="upload-subtitle">Click to add or replace images</span>
    </div>
  </label>

  <div class="checkpoint-gallery" *ngIf="row.imageUrls?.length">
    <div
      class="gallery-item"
      *ngFor="let img of row.imageUrls; let idx = index"
      (click)="openImageGallery(row.imageUrls!, idx)"
    >
      <img [src]="img" [alt]="row.inspectionCheckpointName" />

      <!-- Small remove icon (deactivate image) -->
      <button
        type="button"
        class="image-remove-btn"
        matTooltip="Remove this image from inspection"
        (click)="removeCheckpointImage(row, idx, $event)"
      >
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>
</div>


                      <!-- Default Text (InputType = Text)  - numbers also allowed -->
                      <input
                        *ngSwitchDefault
                        type="text"
                        [(ngModel)]="row.resultValue"
                        placeholder="Enter result..."
                        class="form-input"
                      />
                    </ng-container>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Form Footer -->
          <div class="form-footer">
            <div class="footer-info">
              <mat-icon>info</mat-icon>
              <span>{{ getBlockCompleted(block) }} of {{ getBlockTotal(block) }} checkpoints completed</span>
            </div>

            <div class="footer-actions">
              <button
                mat-stroked-button
                class="cancel-btn"
                (click)="toggleExpanded(block)"
              >
                Cancel
              </button>

              <button
                mat-raised-button
                class="save-btn"
                [disabled]="block.saving"
                (click)="saveInventory(block)"
              >
                <mat-progress-spinner
                  *ngIf="block.saving"
                  diameter="20"
                  mode="indeterminate"
                ></mat-progress-spinner>
                <ng-container *ngIf="!block.saving">
                  <mat-icon>save</mat-icon>
                  <span>Save Inspection</span>
                </ng-container>
              </button>
            </div>
          </div>
        </div>
      </article>
    </div>
  </ng-container>

  <!-- Image Viewer Modal (shared) -->
  <div class="image-viewer" *ngIf="showImageViewer" (click)="closeImageViewer()">
    <div class="viewer-content" (click)="$event.stopPropagation()">
      <button class="viewer-close" (click)="closeImageViewer()">
        <mat-icon>close</mat-icon>
      </button>

      <button
        class="viewer-nav prev"
        (click)="prevImage()"
        [disabled]="selectedImageIndex === 0"
      >
        <mat-icon>chevron_left</mat-icon>
      </button>

      <div class="viewer-image">
        <img [src]="selectedImageGallery[selectedImageIndex]" alt="Vehicle image" />
      </div>

      <button
        class="viewer-nav next"
        (click)="nextImage()"
        [disabled]="selectedImageIndex === selectedImageGallery.length - 1"
      >
        <mat-icon>chevron_right</mat-icon>
      </button>

      <div class="viewer-counter">
        {{ selectedImageIndex + 1 }} / {{ selectedImageGallery.length }}
      </div>
    </div>
  </div>
</div>
