<!-- src/app/pages/inspector/inspections/inspections.html -->
<div class="inspections-shell">
  <!-- Loading -->
  <div *ngIf="loading" class="state state-loading">
    <mat-progress-spinner diameter="42" mode="indeterminate"></mat-progress-spinner>
    <div class="copy">
      <h2>Spinning up your cockpit…</h2>
      <p>Pulling assigned vehicles, images and checklists.</p>
    </div>
  </div>

  <ng-container *ngIf="!loading">
    <!-- Error -->
    <div *ngIf="error" class="state state-error">
      <mat-icon>error_outline</mat-icon>
      <div class="copy">
        <h2>Something went wrong</h2>
        <p>{{ error }}</p>
      </div>
    </div>

    <!-- Main content -->
    <ng-container *ngIf="!error">
      <!-- Hero Header -->
      <header class="page-header">
        <div class="titles">
          <div class="eyebrow">
            <span class="dot"></span>
            Live Inspection Workspace
          </div>
          <h1>Assigned Inspections</h1>
          <p>
            Dive into each vehicle, scan the gallery and punch through every
            checkpoint from mechanical to aesthetics.
          </p>

          <div class="header-chips" *ngIf="blocks.length">
            <span class="chip pill">
              <mat-icon>directions_car</mat-icon>
              {{ blocks.length }} inventory item{{ blocks.length > 1 ? 's' : '' }}
            </span>
            <span class="chip ghost">
              <mat-icon>checklist</mat-icon>
              {{ totalCompleted }}/{{ totalCheckpoints }} checklist answers
            </span>
            <span class="chip accent">
              <mat-icon>bolt</mat-icon>
              {{ (totalCheckpoints ? (totalCompleted / totalCheckpoints) * 100 : 0) | number:'1.0-0' }}%
              overall completion
            </span>
          </div>
        </div>

        <div class="metrics" *ngIf="blocks.length">
          <div class="metric-card">
            <div class="label">Today&apos;s load</div>
            <div class="value">{{ blocks.length }}</div>
            <div class="sub">Vehicles in your queue</div>
          </div>
          <div class="metric-card gradient">
            <div class="label">Checkpoints cleared</div>
            <div class="value">
              {{ totalCompleted }}/{{ totalCheckpoints }}
            </div>
            <div class="bar">
              <div
                class="fill"
                [style.width.%]="totalCheckpoints ? (totalCompleted / totalCheckpoints) * 100 : 0"
              ></div>
            </div>
            <div class="sub">
              {{ (totalCheckpoints ? (totalCompleted / totalCheckpoints) * 100 : 0) | number:'1.0-0' }}% across all vehicles
            </div>
          </div>
        </div>
      </header>

      <!-- Empty state -->
      <section *ngIf="!blocks.length" class="state state-empty">
        <mat-icon>inventory_2</mat-icon>
        <div class="copy">
          <h2>No inventory assigned yet</h2>
          <p>
            As soon as the admin assigns vehicles to you, they will appear here with full
            galleries and inspection grids.
          </p>
        </div>
      </section>

      <!-- Assigned inventory list -->
      <section *ngIf="blocks.length" class="inventory-list">
        <article class="inventory-card" *ngFor="let block of blocks">
          <!-- Card header -->
          <header class="card-header">
            <div class="left">
              <div class="top-row">
                <div class="badge">
                  Inventory #{{ block.inventory.inventoryId }}
                </div>

                <div class="status-chip"
                     [class.status-completed]="getBlockStatus(block) === 'Completed'"
                     [class.status-progress]="getBlockStatus(block) === 'In progress'"
                     [class.status-idle]="getBlockStatus(block) === 'Not started'">
                  <span class="status-dot"></span>
                  {{ getBlockStatus(block) }}
                </div>
              </div>

              <h2>{{ block.productName }}</h2>

              <div class="meta-line primary">
                <span *ngIf="block.productMeta">{{ block.productMeta }}</span>
                <span *ngIf="block.inventory.chassisNo">
                  • Chassis: {{ block.inventory.chassisNo }}
                </span>
                <span *ngIf="block.inventory.registrationNo">
                  • Reg: {{ block.inventory.registrationNo }}
                </span>
              </div>

              <div class="meta-line description" *ngIf="block.inventory.description">
                {{ block.inventory.description }}
              </div>

              <!-- Image strip -->
              <div class="media-strip" *ngIf="block.images && block.images.length">
                <div class="hero-image">
                  <img [src]="block.images[0]" [alt]="block.productName" />
                  <div class="hero-overlay">
                    <mat-icon>photo_camera</mat-icon>
                    <span>{{ block.images.length }} photo{{ block.images.length > 1 ? 's' : '' }}</span>
                  </div>
                </div>

                <div class="thumb-grid">
                  <div class="thumb" *ngFor="let img of block.images | slice:1:4">
                    <img [src]="img" [alt]="block.productName" />
                  </div>
                  <div
                    class="thumb more"
                    *ngIf="block.images.length > 4"
                    [matTooltip]="block.images.length + ' images available'"
                  >
                    +{{ block.images.length - 4 }}
                  </div>
                </div>
              </div>

              <!-- Quick stats row -->
              <div class="quick-stats">
                <div class="stat-pill">
                  <span class="label">Checklist</span>
                  <span class="value">
                    {{ getBlockCompleted(block) }}/{{ getBlockTotal(block) }}
                  </span>
                </div>
                <div class="stat-pill">
                  <span class="label">Completion</span>
                  <span class="value">
                    {{ getBlockProgressPercent(block) }}%
                  </span>
                </div>
                <div class="stat-pill">
                  <span class="label">Images</span>
                  <span class="value">{{ block.images.length || 0 }}</span>
                </div>

              </div>

              <!-- Progress bar -->
              <div class="progress-track">
                <div class="track">
                  <div
                    class="track-fill"
                    [style.width.%]="getBlockProgressPercent(block)"
                  ></div>
                </div>
                <span class="track-label">
                  {{ getBlockProgressPercent(block) }}% of this vehicle inspected
                </span>
              </div>
            </div>

            <div class="right">
              <div class="progress-pill" matTooltip="Answered vs total checkpoints">
                <mat-icon>playlist_add_check</mat-icon>
                <span>
                  {{ getBlockCompleted(block) }}/{{ getBlockTotal(block) }}
                </span>
              </div>

              <button
                mat-stroked-button
                class="toggle-btn"
                type="button"
                (click)="toggleExpanded(block)"
              >
                <mat-icon>
                  {{ block.expanded ? 'expand_less' : 'expand_more' }}
                </mat-icon>
                {{ block.expanded ? 'Hide checklist' : 'Open checklist' }}
              </button>
            </div>
          </header>

          <!-- Checklist body -->
          <section class="card-body" *ngIf="block.expanded">
            <!-- Section header strip -->
            <div class="body-banner">
              <div class="banner-left">
                <span class="banner-icon">
                  <mat-icon>rule_folder</mat-icon>
                </span>
                <div class="banner-text">
                  <div class="title">Inspection grid unlocked</div>
                  <div class="subtitle">
                    Work through each cluster. Yes/No blocks are for pass / fail,
                    others are open comments or numeric scores.
                  </div>
                </div>
              </div>
              <div class="banner-tags">
                <span class="tag">
                  <mat-icon>build</mat-icon>
                  Mechanical
                </span>
                <span class="tag">
                  <mat-icon>directions_car</mat-icon>
                  Exterior
                </span>
                <span class="tag">
                  <mat-icon>event_seat</mat-icon>
                  Interior
                </span>
              </div>
            </div>

            <div class="type-group" *ngFor="let group of block.groups">
              <div class="type-header">
                <div class="title">
                  <span class="type-pill">
                    <mat-icon>check_circle_outline</mat-icon>
                    {{ group.inspectionTypeName }}
                  </span>
                  <span class="weight" *ngIf="group.weightage">
                    {{ group.weightage }}%
                  </span>
                </div>

                <div class="counts">
                  <span
                    class="pill done"
                    *ngIf="
                      getGroupCompleted(group) === group.checkpoints.length &&
                      group.checkpoints.length
                    "
                  >
                    <mat-icon>verified</mat-icon>
                    Cluster complete
                  </span>

                  <span
                    class="pill"
                    *ngIf="getGroupCompleted(group) !== group.checkpoints.length"
                  >
                    <mat-icon>pending_actions</mat-icon>
                    {{ getGroupCompleted(group) }}/{{ group.checkpoints.length }}
                    answered
                  </span>
                </div>
              </div>

              <div class="checkpoints">
                <div class="checkpoint-row" *ngFor="let row of group.checkpoints">
                  <div class="label">
                    <span class="label-main">{{ row.inspectionCheckpointName }}</span>
                    <span class="label-sub" *ngIf="normalizeInputType(row.inputType) === 'yesno'">
                      Tap Pass / Fail
                    </span>
                    <span class="label-sub" *ngIf="normalizeInputType(row.inputType) === 'number'">
                      Numeric score (0-10, mileage, etc.)
                    </span>
                    <span class="label-sub" *ngIf="normalizeInputType(row.inputType) === 'textarea'">
                      Free-form notes &amp; observations
                    </span>
                  </div>

                  <div class="control">
                    <ng-container [ngSwitch]="normalizeInputType(row.inputType)">
                      <!-- Textarea -->
                      <textarea
                        *ngSwitchCase="'textarea'"
                        [(ngModel)]="row.resultValue"
                        rows="3"
                        placeholder="Describe findings, damage, smells, noises, etc."
                      ></textarea>

                      <!-- Number -->
                      <input
                        *ngSwitchCase="'number'"
                        type="number"
                        [(ngModel)]="row.resultValue"
                        placeholder="Enter numeric score / reading"
                      />

                      <!-- Yes / No -->
                      <div *ngSwitchCase="'yesno'" class="yesno-toggle">
                        <button
                          type="button"
                          [class.active]="row.resultValue === 'Pass'"
                          (click)="setYesNo(row, 'Pass')"
                        >
                          <mat-icon>thumb_up</mat-icon>
                          Pass
                        </button>
                        <button
                          type="button"
                          [class.active]="row.resultValue === 'Fail'"
                          (click)="setYesNo(row, 'Fail')"
                        >
                          <mat-icon>thumb_down</mat-icon>
                          Fail
                        </button>
                      </div>

                      <!-- Default text -->
                      <input
                        *ngSwitchDefault
                        type="text"
                        [(ngModel)]="row.resultValue"
                        placeholder="Enter result or short remark"
                      />
                    </ng-container>
                  </div>
                </div>
              </div>
            </div>

            <!-- Card footer -->
            <footer class="card-footer">
              <div class="left">
                <span class="hint">
                  {{ getBlockCompleted(block) }}/{{ getBlockTotal(block) }}
                  checkpoints answered for this vehicle
                </span>
              </div>

              <div class="right">
                <button
                  mat-stroked-button
                  type="button"
                  class="collapse-btn"
                  (click)="toggleExpanded(block)"
                >
                  Collapse view
                </button>

                <button
                  mat-flat-button
                  type="button"
                  class="save-btn"
                  [disabled]="block.saving"
                  (click)="saveInventory(block)"
                >
                  <mat-progress-spinner
                    *ngIf="block.saving"
                    diameter="18"
                    mode="indeterminate"
                  ></mat-progress-spinner>
                  <ng-container *ngIf="!block.saving">
                    <mat-icon>save</mat-icon>
                    <span>Save inspection</span>
                  </ng-container>
                </button>
              </div>
            </footer>
          </section>
        </article>
      </section>
    </ng-container>
  </ng-container>
</div>
