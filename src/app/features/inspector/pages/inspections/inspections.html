<!-- src/app/pages/inspector/inspections/inspections.html -->
<div class="inspections-page">

  <!-- Hero Section -->
  <section class="hero-section" *ngIf="!loading && !error">
    
    <div class="hero-content-wrapper animate-on-scroll" style="animation-delay: 0ms">
      
      <!-- Hero Header -->
      <div class="hero-header">
        <div class="eyebrow-badge">
          <span class="badge-dot"></span>
          <span class="badge-text">Inspector Portal</span>
          <span class="badge-dot"></span>
        </div>

        <h1 class="hero-title">
          <span class="title-line">Premium Vehicle</span>
          <span class="title-line title-accent">Inspections</span>
        </h1>

        <p class="hero-subtitle">
          Precision engineering meets meticulous craftsmanshipâ€”delivering world-class inspection reports
        </p>
      </div>

      <!-- Stats Grid -->
      <div class="stats-grid" *ngIf="blocks.length">
        
        <!-- Assigned Vehicles Stat -->
        <div class="stat-card animate-on-scroll" style="animation-delay: 100ms">
          <div class="stat-icon" style="background: #2c3e50">
            <mat-icon>directions_car</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ blocks.length }}</div>
            <div class="stat-label">Assigned Vehicles</div>
          </div>
          <div class="stat-trend up">
            <mat-icon>trending_up</mat-icon>
            <span>Active</span>
          </div>
        </div>

        <!-- Completed Checkpoints Stat -->
        <div class="stat-card animate-on-scroll" style="animation-delay: 200ms">
          <div class="stat-icon" style="background: #27ae60">
            <mat-icon>task_alt</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ totalCompleted }}</div>
            <div class="stat-label">Checkpoints Complete</div>
          </div>
          <div class="stat-trend up">
            <mat-icon>trending_up</mat-icon>
            <span>+{{ totalCompleted }}</span>
          </div>
        </div>

        <!-- Remaining Tasks Stat -->
        <div class="stat-card animate-on-scroll" style="animation-delay: 300ms">
          <div class="stat-icon" style="background: #f39c12">
            <mat-icon>pending</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ totalCheckpoints - totalCompleted }}</div>
            <div class="stat-label">Remaining Tasks</div>
          </div>
          <div class="stat-trend">
            <mat-icon>hourglass_empty</mat-icon>
            <span>Pending</span>
          </div>
        </div>

        <!-- Overall Progress Stat -->
        <div class="stat-card stat-featured animate-on-scroll" style="animation-delay: 400ms">
          
          <!-- Circular Progress -->
          <div class="circular-progress">
            <svg viewBox="0 0 120 120">
              <circle class="progress-bg" cx="60" cy="60" r="52"></circle>
              <circle
                class="progress-fill"
                cx="60"
                cy="60"
                r="52"
                [style.strokeDashoffset]="326.73 - (326.73 * (totalCheckpoints ? (totalCompleted / totalCheckpoints) : 0))"
              ></circle>
            </svg>
            
            <div class="progress-value">
              <span class="value-number">{{ (totalCheckpoints ? (totalCompleted / totalCheckpoints) * 100 : 0) | number:'1.0-0' }}</span>
              <span class="value-unit">%</span>
            </div>
          </div>

          <div class="stat-content">
            <div class="stat-label">Overall Progress</div>
            <p class="stat-description">Portfolio completion</p>
          </div>
        </div>

      </div>

      <!-- Quick Access Pills -->
      <div class="quick-access" *ngIf="blocks.length" class="animate-on-scroll" style="animation-delay: 500ms">
        <div class="section-divider">
          <span class="divider-line"></span>
          <span class="divider-text">Quick Access</span>
          <span class="divider-line"></span>
        </div>

        <div class="access-pills">
          <button
            type="button"
            class="access-pill"
            *ngFor="let block of blocks | slice:0:5; let i = index"
            (click)="scrollToInventory(block.inventory.inventoryId)"
          >
            <div class="pill-avatar" *ngIf="block.images?.length; else avatarPlaceholder">
              <img [src]="block.images[0]" [alt]="block.productName" />
            </div>
            <ng-template #avatarPlaceholder>
              <div class="pill-avatar pill-avatar-empty">
                <mat-icon>directions_car</mat-icon>
              </div>
            </ng-template>

            <div class="pill-info">
              <span class="pill-name">{{ block.productName }}</span>
              <span class="pill-meta">{{ block.registrationNo }}</span>
            </div>

            <div class="pill-progress">
              <span class="progress-percent">{{ getBlockProgressPercent(block) }}%</span>
            </div>

            <mat-icon class="pill-arrow">arrow_forward</mat-icon>
          </button>

          <button
            type="button"
            class="access-pill access-pill-all"
            *ngIf="blocks.length > 5"
          >
            <div class="pill-avatar pill-avatar-gradient">
              <mat-icon>grid_view</mat-icon>
            </div>
            <div class="pill-info">
              <span class="pill-name">View All Vehicles</span>
              <span class="pill-meta">{{ blocks.length }} total assignments</span>
            </div>
            <mat-icon class="pill-arrow">expand_more</mat-icon>
          </button>
        </div>
      </div>

    </div>
  </section>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="loading">
    <div class="loading-container">
      <mat-spinner diameter="64" color="primary"></mat-spinner>
      <h3>Loading Inspections</h3>
      <p>Preparing your inspection portfolio...</p>
    </div>
  </div>

  <!-- Error State -->
  <div class="error-state animate-on-scroll" *ngIf="!loading && error">
    <div class="error-icon">
      <mat-icon>warning_amber</mat-icon>
    </div>
    <div class="error-content">
      <h3>Unable to Load Inspections</h3>
      <p>{{ error }}</p>
      <button mat-flat-button color="primary" (click)="loadData()">Retry</button>
    </div>
  </div>

  <!-- Main Content -->
  <ng-container *ngIf="!loading && !error">

    <!-- Empty State -->
    <div class="empty-state animate-on-scroll" *ngIf="!blocks.length">
      <div class="empty-icon">
        <mat-icon>inventory_2</mat-icon>
      </div>
      <h2>No Vehicles Assigned</h2>
      <p>Your inspection queue is currently empty. New assignments will appear here automatically.</p>
    </div>

    <!-- Vehicles Grid -->
    <div class="vehicles-grid" *ngIf="blocks.length">
      <article
        class="vehicle-card animate-on-scroll"
        [class.expanded]="block.expanded"
        *ngFor="let block of blocks; let i = index"
        [attr.id]="'inv-' + block.inventory.inventoryId"
        [style.animation-delay]="(600 + i * 100) + 'ms'"
      >

        <!-- Card Header -->
        <div class="card-header">
          <div class="image-container">
            <ng-container *ngIf="block.images?.length; else noImage">
              <img [src]="block.images[0]" [alt]="block.productName" class="vehicle-image" />
            </ng-container>
            <ng-template #noImage>
              <div class="image-placeholder">
                <mat-icon>directions_car</mat-icon>
              </div>
            </ng-template>
          </div>

          <div class="header-badges">
            <div class="inventory-badge">INV-{{ block.inventory.inventoryId }}</div>
            <div class="status-badge" [style.background]="getStatusColor(getBlockStatus(block))">
              {{ getBlockStatus(block) }}
            </div>
          </div>
        </div>

        <!-- Card Content -->
        <div class="card-content">

          <!-- Vehicle Info -->
          <div class="vehicle-info">
            <h2 class="vehicle-name">{{ block.productName }}</h2>
            <p class="vehicle-meta">{{ block.productMeta }}</p>
          </div>

          <!-- Details Grid -->
          <div class="details-grid">
            <div class="detail-item">
              <div class="detail-icon">
                <mat-icon>confirmation_number</mat-icon>
              </div>
              <div class="detail-text">
                <span class="detail-label">Registration</span>
                <span class="detail-value">{{ block.registrationNo }}</span>
              </div>
            </div>

            <div class="detail-item">
              <div class="detail-icon">
                <mat-icon>pin</mat-icon>
              </div>
              <div class="detail-text">
                <span class="detail-label">Chassis</span>
                <span class="detail-value">{{ block.chassisNo }}</span>
              </div>
            </div>
          </div>

          <!-- Progress -->
          <div class="progress-section">
            <div class="progress-header">
              <span class="progress-label">Inspection Progress</span>
              <span class="progress-count">{{ getBlockCompleted(block) }}/{{ getBlockTotal(block) }}</span>
            </div>

            <div class="progress-bar-container">
              <div
                class="progress-bar-fill"
                [style.width.%]="getBlockProgressPercent(block)"
              ></div>
            </div>

            <span class="progress-percentage">{{ getBlockProgressPercent(block) }}% Complete</span>
          </div>

          <!-- Gallery Preview -->
          <div class="gallery-preview" *ngIf="block.images?.length">
            <div class="gallery-header">
              <mat-icon>collections</mat-icon>
              <span>{{ block.images.length }} Photos</span>
            </div>

            <div class="gallery-grid">
              <div
                class="gallery-thumb"
                *ngFor="let img of block.images | slice:0:3; let idx = index"
                (click)="openImageGallery(block.images, idx)"
              >
                <img [src]="img" [alt]="block.productName" />
                <div class="thumb-overlay">
                  <mat-icon>zoom_in</mat-icon>
                </div>
              </div>

              <div
                class="gallery-thumb gallery-more"
                *ngIf="block.images.length > 3"
                (click)="openImageGallery(block.images, 3)"
              >
                <div class="more-content">
                  <mat-icon>add</mat-icon>
                  <span>{{ block.images.length - 3 }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Expand Button -->
          <button
            class="expand-btn"
            (click)="toggleExpanded(block)"
            mat-flat-button
            color="primary"
          >
            <mat-icon>{{ block.expanded ? 'expand_less' : 'expand_more' }}</mat-icon>
            <span>{{ block.expanded ? 'Close' : 'Begin' }} Inspection</span>
          </button>
        </div>

        <!-- Expanded Form -->
        <div class="inspection-form" *ngIf="block.expanded">

          <div class="form-divider"></div>

          <!-- Form Intro -->
          <div class="form-header">
            <div class="header-icon">
              <mat-icon>fact_check</mat-icon>
            </div>
            <div class="header-text">
              <h3>Comprehensive Inspection Checklist</h3>
              <p>Complete all checkpoints for thorough documentation</p>
            </div>
          </div>

          <!-- Inspection Groups -->
          <div class="inspection-groups">
            <div
              class="inspection-group"
              *ngFor="let group of block.groups"
            >

              <!-- Group Header -->
              <div class="group-header">
                <div class="group-title-section">
                  <div class="group-icon">
                    <mat-icon>category</mat-icon>
                  </div>
                  <div class="group-text">
                    <h4 class="group-title">{{ group.inspectionTypeName }}</h4>
                    <span class="group-subtitle">{{ group.checkpoints.length }} checkpoints</span>
                  </div>
                  <span class="weightage-badge" *ngIf="group.weightage">{{ group.weightage }}%</span>
                </div>

                <div class="group-progress">
                  <div class="progress-indicator" [class.complete]="getGroupCompleted(group) === group.checkpoints.length">
                    <mat-icon>{{ getGroupCompleted(group) === group.checkpoints.length ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
                    <span>{{ getGroupCompleted(group) }}/{{ group.checkpoints.length }}</span>
                  </div>
                </div>
              </div>

              <!-- Checkpoints -->
              <div class="checkpoints-list">
                <div
                  class="checkpoint"
                  [class.completed]="isRowAnswered(row)"
                  *ngFor="let row of group.checkpoints"
                >

                  <div class="checkpoint-header">
                    <div class="checkpoint-icon">
                      <mat-icon>{{ isRowAnswered(row) ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
                    </div>
                    <div class="checkpoint-title">
                      <h5>{{ row.inspectionCheckpointName }}</h5>
                      <p *ngIf="normalizeInputType(row.inputType) === 'yesno'">Pass/Fail assessment</p>
                      <p *ngIf="normalizeInputType(row.inputType) === 'number'">Numeric measurement</p>
                      <p *ngIf="normalizeInputType(row.inputType) === 'textarea'">Detailed observations</p>
                      <p *ngIf="normalizeInputType(row.inputType) === 'image'">Photo documentation</p>
                    </div>
                  </div>

                  <!-- Input Fields -->
                  <div class="checkpoint-input">
                    <ng-container [ngSwitch]="normalizeInputType(row.inputType)">

                      <!-- Textarea -->
                      <textarea
                        *ngSwitchCase="'textarea'"
                        [(ngModel)]="row.resultValue"
                        rows="4"
                        placeholder="Enter detailed observations..."
                        class="form-textarea"
                      ></textarea>

                      <!-- Number -->
                      <input
                        *ngSwitchCase="'number'"
                        type="number"
                        [(ngModel)]="row.resultValue"
                        placeholder="Enter numeric value"
                        class="form-input"
                      />

                      <!-- Yes/No -->
                      <div class="toggle-buttons" *ngSwitchCase="'yesno'">
                        <button
                          type="button"
                          class="toggle-btn pass"
                          [class.active]="row.resultValue === 'Pass'"
                          (click)="setYesNo(row, 'Pass')"
                        >
                          <mat-icon>check_circle</mat-icon>
                          <span>Pass</span>
                        </button>
                        <button
                          type="button"
                          class="toggle-btn fail"
                          [class.active]="row.resultValue === 'Fail'"
                          (click)="setYesNo(row, 'Fail')"
                        >
                          <mat-icon>cancel</mat-icon>
                          <span>Fail</span>
                        </button>
                      </div>

                      <!-- Image Upload -->
                      <div class="image-upload" *ngSwitchCase="'image'">
                        <label class="upload-area">
                          <input
                            type="file"
                            accept="image/*"
                            multiple
                            (change)="uploadCheckpointImages(block, group, row, $event)"
                          />
                          <div class="upload-content">
                            <div class="upload-icon">
                              <mat-icon>add_photo_alternate</mat-icon>
                            </div>
                            <div class="upload-text">
                              <span class="upload-title">Upload Documentation</span>
                              <span class="upload-subtitle">Click to browse</span>
                            </div>
                          </div>
                        </label>

                        <!-- Uploaded Images -->
                        <div class="uploaded-images" *ngIf="row.imageUrls?.length">
                          <div
                            class="uploaded-image"
                            *ngFor="let img of row.imageUrls; let imgIdx = index"
                            (click)="openImageGallery(row.imageUrls!, imgIdx)"
                          >
                            <img [src]="img" [alt]="row.inspectionCheckpointName" />
                            <button
                              type="button"
                              class="remove-btn"
                              (click)="removeCheckpointImage(row, imgIdx, $event)"
                              matTooltip="Remove image"
                            >
                              <mat-icon>close</mat-icon>
                            </button>
                          </div>
                        </div>
                      </div>

                      <!-- Default Text -->
                      <input
                        *ngSwitchDefault
                        type="text"
                        [(ngModel)]="row.resultValue"
                        placeholder="Enter inspection result..."
                        class="form-input"
                      />
                    </ng-container>
                  </div>

                </div>
              </div>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <div class="actions-info">
              <mat-icon>info</mat-icon>
              <span>{{ getBlockCompleted(block) }} of {{ getBlockTotal(block) }} completed</span>
            </div>

            <div class="actions-buttons">
              <button mat-stroked-button (click)="toggleExpanded(block)">Cancel</button>

              <button
                mat-flat-button
                color="primary"
                [disabled]="block.saving"
                (click)="saveInventory(block)"
              >
                <mat-progress-spinner
                  *ngIf="block.saving"
                  diameter="18"
                  mode="indeterminate"
                ></mat-progress-spinner>
                <ng-container *ngIf="!block.saving">
                  <mat-icon>save</mat-icon>
                  <span>Save Inspection</span>
                </ng-container>
              </button>
            </div>
          </div>

        </div>
      </article>
    </div>

  </ng-container>

  <!-- Image Viewer -->
  <div class="image-viewer" *ngIf="showImageViewer" (click)="closeImageViewer()">
    <div class="viewer-backdrop"></div>

    <div class="viewer-container" (click)="$event.stopPropagation()">

      <button class="viewer-close" (click)="closeImageViewer()" mat-icon-button>
        <mat-icon>close</mat-icon>
      </button>

      <button
        class="viewer-nav prev"
        (click)="prevImage()"
        [disabled]="selectedImageIndex === 0"
        mat-icon-button
      >
        <mat-icon>chevron_left</mat-icon>
      </button>

      <div class="viewer-image">
        <img
          [src]="selectedImageGallery[selectedImageIndex]"
          alt="Inspection photo"
        />
      </div>

      <button
        class="viewer-nav next"
        (click)="nextImage()"
        [disabled]="selectedImageIndex === selectedImageGallery.length - 1"
        mat-icon-button
      >
        <mat-icon>chevron_right</mat-icon>
      </button>

      <div class="viewer-counter">
        {{ selectedImageIndex + 1 }} / {{ selectedImageGallery.length }}
      </div>
    </div>
  </div>

</div>